<!doctype html>
<html>
  <head>
    <title>Sudachi Grammar Matcher</title>
  </head>
  <body>
    <h1>Sudachi Grammar Matcher Test</h1>
    <pre id="output">Loading Sudachi...</pre>

    <!-- Load Sudachi Wasm wrapper -->
    <script type="module">
      console.time("import");

      import {
        SudachiStateless,
        TokenizeMode,
      } from "../sudachi-wasm/sudachi.js";

      import { runGrammarEngineCheck } from "./grammar-engine.js";

      console.timeEnd("import");
      const outputEl = document.getElementById("output");

      // --- App State ---
      const state = (window.state = {
        sudachi: null,
      });

      // --- Helpers: Dictionary & Parsing ---

      async function fetchJsonData(url) {
        try {
          // 1. Fetch the resource from the URL. The fetch() method returns a Promise that resolves to a Response object.
          const response = await fetch(url);

          // Check if the request was successful
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }

          // 2. Parse the response body as JSON. response.json() also returns a Promise, resolving to a JavaScript object.
          const jsonData = await response.json();

          // 3. Work with the parsed JavaScript object
          return jsonData;
        } catch (error) {
          // Handle any errors that occurred during the fetch or parsing process
          console.error("Error fetching or parsing data:", error);
        }
      }

      async function fetchAndGunzip(url) {
        const response = await fetch(url);
        if (!response.body) throw new Error("No response body");
        const ds = new DecompressionStream("gzip");
        const stream = response.body.pipeThrough(ds);
        return await new Response(stream).blob();
      }

      // --- Sudachi Handling ---
      async function initSudachi() {
        console.log("init sudachi");
        try {
          outputEl.innerText = "Downloading dictionary...";
          let dictBlob = await fetchAndGunzip(
            "../sudachi-wasm/resources/system.dic.gz",
          );
          const buffer = await dictBlob.arrayBuffer();
          const uint8Array = new Uint8Array(buffer);

          state.sudachi = new SudachiStateless();
          await state.sudachi.initialize_from_bytes(uint8Array);
          outputEl.innerText = "Dictionary loaded";
        } catch (err) {
          outputEl.innerText = "Dict error: " + err.message;
        }
      }

      async function init() {
        await initSudachi();

        var n5Rules = await fetchJsonData("n5-grammar-rules.json");
        var n4Rules = await fetchJsonData("n4-grammar-rules.json");
        var n3Rules = await fetchJsonData("n3-grammar-rules.json");
        var rules = [...n5Rules, ...n4Rules, ...n3Rules];
        try {
          outputEl.textContent = "Sudachi Loaded. Running Tests...\n";

          // 2. Hook up console.log to screen for demo
          const oldLog = console.log;
          console.log = function (...args) {
            oldLog(...args);
            outputEl.textContent += args.join(" ") + "\n";
          };

          // 3. Run the engine
          await runGrammarEngineCheck(state.sudachi, rules);
        } catch (e) {
          outputEl.textContent = "Error: " + e.message;
          console.error(e);
        }
      }

      init();
    </script>
  </body>
</html>
