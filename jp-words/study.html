--- START OF FILE study.html ---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CSV Flashcard Study</title>
    <style>
      :root {
        --primary: #3b82f6;
        --bg: #f8fafc;
        --card-bg: #ffffff;
        --text: #1e293b;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        background-color: var(--bg);
        color: var(--text);
        margin: 0;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
      }

      /* Input Section */
      #setup-container {
        width: 100%;
        max-width: 800px;
        margin-bottom: 20px;
      }

      .input-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
        align-items: center;
        flex-wrap: wrap;
      }

      /* File Upload Styling */
      input[type="file"] {
        display: none;
      }

      .custom-file-upload {
        border: 1px solid #cbd5e1;
        display: inline-block;
        padding: 6px 12px;
        cursor: pointer;
        background: white;
        border-radius: 6px;
        font-size: 0.9rem;
        color: #475569;
      }

      .custom-file-upload:hover {
        background: #f1f5f9;
      }

      /* Sort Dropdown */
      select {
        padding: 6px 12px;
        border-radius: 6px;
        border: 1px solid #cbd5e1;
        background: white;
        color: #475569;
        font-size: 0.9rem;
      }

      textarea {
        width: 100%;
        height: 150px;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-family: monospace;
        margin-bottom: 10px;
        resize: vertical;
        box-sizing: border-box;
      }

      button {
        background-color: var(--primary);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1rem;
        transition: background 0.2s;
      }

      button:hover {
        filter: brightness(90%);
      }

      .reset-link {
        font-size: 0.8rem;
        color: #64748b;
        text-decoration: underline;
        cursor: pointer;
        margin-left: auto;
      }

      /* List View */
      #list-container {
        width: 100%;
        max-width: 800px;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 15px;
      }

      .word-item {
        background: var(--card-bg);
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        text-align: center;
        position: relative;
        cursor: default;
        transition: opacity 0.3s;
      }

      .word-item.ignored {
        opacity: 0.5;
        background: #f1f5f9;
      }

      .checkbox-wrapper {
        position: absolute;
        top: 10px;
        left: 10px;
      }

      .word-item .kanji {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 5px;
        margin-top: 10px;
      }

      .word-item .details {
        opacity: 0;
        transition: opacity 0.2s;
        height: 50px;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      .word-item:hover .details {
        opacity: 1;
      }

      .word-item .furigana {
        color: #64748b;
        font-size: 0.9rem;
      }

      .word-item .meaning {
        font-size: 0.9rem;
        color: var(--text);
      }

      .word-item .stats {
        margin-top: 10px;
        font-size: 0.7rem;
        color: #94a3b8;
        border-top: 1px solid #eee;
        padding-top: 5px;
      }

      /* Flashcard Full Page Mode */
      #flashcard-container {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: var(--bg);
        z-index: 100;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }

      .card {
        background: var(--card-bg);
        width: 90%;
        max-width: 500px;
        min-height: 350px;
        padding: 40px;
        border-radius: 16px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: relative;
      }

      .card-counter {
        position: absolute;
        top: 20px;
        left: 20px;
        font-size: 0.9rem;
        color: #94a3b8;
        font-weight: bold;
      }

      .card-main-text {
        font-size: 4rem;
        font-weight: bold;
        margin-bottom: 20px;
      }

      .card-sub-info {
        font-size: 1.5rem;
        color: #475569;
        margin-bottom: 10px;
      }

      .card-meaning {
        font-size: 1.2rem;
        color: #64748b;
        margin-bottom: 30px;
      }

      .controls {
        margin-top: 30px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
        width: 100%;
      }

      .btn-easy {
        background-color: #22c55e;
        flex: 1;
      }
      .btn-diff {
        background-color: #ef4444;
        flex: 1;
      }
      .btn-again {
        background-color: #f59e0b;
        flex: 1;
      }
      .btn-never {
        background-color: #475569;
        flex: 1;
      }

      .nav-controls {
        display: flex;
        gap: 10px;
        width: 100%;
      }

      .btn-next {
        background-color: #3b82f6;
        flex: 2;
      }
      .btn-back {
        background-color: #64748b;
        flex: 1;
      }

      .shortcut-hint {
        position: absolute;
        bottom: 20px;
        font-size: 0.8rem;
        color: #94a3b8;
      }

      .exit-btn {
        position: absolute;
        top: 20px;
        right: 20px;
        background: transparent;
        color: #64748b;
        border: 1px solid #cbd5e1;
      }
    </style>
  </head>
  <body>
    <!-- Setup / List View -->
    <div id="setup-container">
      <h2>Vocabulary Study</h2>

      <div class="input-controls">
        <label for="csv-file-upload" class="custom-file-upload">
          ðŸ“‚ Upload CSV File
        </label>
        <input
          id="csv-file-upload"
          type="file"
          accept=".csv"
          onchange="handleFileUpload(this)"
        />

        <select id="sort-select" onchange="parseAndRenderList()">
          <option value="csv">Sort: CSV Order</option>
          <option value="easy">Sort: Highest Easy Count</option>
          <option value="hard">Sort: Highest Difficult + Again</option>
        </select>
      </div>

      <textarea id="csv-input" placeholder="Paste CSV here..."></textarea>

      <div
        style="display: flex; justify-content: flex-end; align-items: center"
      >
        <button onclick="startStudySession()">Start Flashcard Study</button>
      </div>
    </div>

    <div id="list-container"></div>

    <!-- Flashcard View -->
    <div id="flashcard-container">
      <button class="exit-btn" onclick="exitStudy()">Exit</button>
      <div id="card-display" class="card">
        <!-- Content injected via JS -->
      </div>
      <div class="shortcut-hint">
        Shortcuts: (E)asy, (D)ifficult, (A)gain, (N)ever, (Enter/Space) Next,
        (Backspace) Undo
      </div>
    </div>

    <script>
      // --- Constants & Config ---
      const DEFAULT_CSV = `level,kanji,furigana,definition,kana
"1","å‡ºã™","ã ","to take out / to submit","ã ã™"
"1","å¤§äºº","ãŠã¨ãª","adult","ãŠã¨ãª"
"1","è¦‹ãˆã‚‹","ã¿","to be visible","ã¿ãˆã‚‹"
"1","å‡ºã‚‹","ã§","to go out / to exit","ã§ã‚‹"
"1","ã‹ã‚‰","","from / because","ã‹ã‚‰"
"1","å°å­¦æ ¡","ã—ã‚‡ã†ãŒã£ã“ã†","elementary school","ã—ã‚‡ã†ãŒã£ã“ã†"
"1","å¤©æ°—","ã¦ã‚“ã","weather","ã¦ã‚“ã"
"1","ç™½ã„","ã—ã‚","white","ã—ã‚ã„"
"1","ã¿ã‚“ãª","","everyone","ã¿ã‚“ãª"
"1","å·","ã‹ã‚","river","ã‹ã‚"
"1","ã¡ã‚‡ã£ã¨","","a little","ã¡ã‚‡ã£ã¨"`;

      // localStorage Keys
      const STATS_KEY = "flashcard_stats";
      const IGNORED_KEY = "flashcard_ignored";
      const CSV_DATA_KEY = "flashcard_csv_data";

      // --- State Management ---
      let cards = [];
      let studyQueue = [];
      let initialSessionCount = 0;
      let currentCard = null;
      let isCardBackVisible = false;
      let lastActionState = null;
      let debounceTimer = null;

      // --- Initialization ---
      function init() {
        // Load saved CSV or Default
        const savedCSV = localStorage.getItem(CSV_DATA_KEY);
        const inputArea = document.getElementById("csv-input");
        inputArea.value = savedCSV ? savedCSV : DEFAULT_CSV;

        // Setup Auto-Refresh Listener
        inputArea.addEventListener("input", handleInputDebounce);

        // Initial Render
        parseAndRenderList();
      }

      // --- Input Handling & File Upload ---
      function handleInputDebounce(e) {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
          const content = e.target.value;
          localStorage.setItem(CSV_DATA_KEY, content);
          parseAndRenderList();
        }, 500); // 500ms delay
      }

      function handleFileUpload(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          const content = e.target.result;
          const textarea = document.getElementById("csv-input");
          textarea.value = content;
          // Save and render immediately
          localStorage.setItem(CSV_DATA_KEY, content);
          parseAndRenderList();
        };
        reader.readAsText(file);
        input.value = "";
      }

      function resetToDefault() {
        if (
          confirm(
            "This will overwrite your current list with the sample data. Continue?"
          )
        ) {
          const textarea = document.getElementById("csv-input");
          textarea.value = DEFAULT_CSV;
          localStorage.setItem(CSV_DATA_KEY, DEFAULT_CSV);
          parseAndRenderList();
        }
      }

      // --- Helper: Statistics & Settings ---
      function getStats() {
        const data = localStorage.getItem(STATS_KEY);
        return data ? JSON.parse(data) : {};
      }

      function updateStat(word, type, increment = true) {
        const stats = getStats();
        if (!stats[word]) {
          stats[word] = { easy: 0, difficult: 0, again: 0 };
        }
        if (increment) {
          stats[word][type]++;
        } else {
          if (stats[word][type] > 0) stats[word][type]--;
        }
        localStorage.setItem(STATS_KEY, JSON.stringify(stats));
      }

      function getStatString(word) {
        const stats = getStats();
        const s = stats[word] || { easy: 0, difficult: 0, again: 0 };
        return `E: ${s.easy} | D: ${s.difficult} | A: ${s.again}`;
      }

      function getIgnoredCards() {
        const data = localStorage.getItem(IGNORED_KEY);
        return data ? JSON.parse(data) : [];
      }

      function toggleIgnoredCard(kanji) {
        let ignored = getIgnoredCards();
        if (ignored.includes(kanji)) {
          ignored = ignored.filter((k) => k !== kanji);
        } else {
          ignored.push(kanji);
        }
        localStorage.setItem(IGNORED_KEY, JSON.stringify(ignored));
        parseAndRenderList();
      }

      // --- CSV Parsing ---
      function parseCSV(text) {
        const lines = text.trim().split("\n");
        const data = [];
        for (let i = 1; i < lines.length; i++) {
          const match = lines[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
          if (match) {
            const clean = match.map((val) => val.replace(/^"|"$/g, ""));
            if (clean.length >= 5) {
              data.push({
                level: clean[0],
                kanji: clean[1],
                furigana: clean[2],
                definition: clean[3],
                kana: clean[4],
              });
            }
          }
        }
        return data;
      }

      // --- Templates ---
      const listItemTemplate = (card, statsStr, isIgnored) => `
            <div class="word-item ${isIgnored ? "ignored" : ""}">
                <div class="checkbox-wrapper">
                    <input type="checkbox" 
                        ${!isIgnored ? "checked" : ""} 
                        onchange="toggleIgnoredCard('${card.kanji}')"
                    >
                </div>
                <div class="kanji">${card.kanji}</div>
                <div class="details">
                    <div class="furigana">${card.kana || card.furigana}</div>
                    <div class="meaning">${card.definition}</div>
                </div>
                <div class="stats">${statsStr}</div>
            </div>
        `;

      const getCounterText = () => {
        return `${studyQueue.length} Remaining / ${initialSessionCount} Total`;
      };

      const cardFrontTemplate = (card) => `
            <div class="card-counter">${getCounterText()}</div>
            <div class="card-main-text">${card.kanji}</div>
            <div class="controls">
                <button class="btn-easy" onclick="handleResponse('easy')">Easy (E)</button>
                <button class="btn-diff" onclick="handleResponse('difficult')">Difficult (D)</button>
                <button class="btn-again" onclick="handleResponse('again')">Again (A)</button>
            </div>
            <div class="controls">
                <button class="btn-never" onclick="handleNever()">Never (N)</button>
            </div>
        `;

      const cardBackTemplate = (card) => `
            <div class="card-counter">${getCounterText()}</div>
            <div class="card-main-text">${card.kanji}</div>
            <div class="card-sub-info">${card.kana}</div>
            <div class="card-meaning">${card.definition}</div>
            
            <!-- Rating Controls (Overwrite) -->
            <div class="controls">
                <button class="btn-easy" onclick="handleResponse('easy', true)">Easy (E)</button>
                <button class="btn-diff" onclick="handleResponse('difficult', true)">Difficult (D)</button>
                <button class="btn-again" onclick="handleResponse('again', true)">Again (A)</button>
            </div>
            
            <div class="controls">
                <button class="btn-never" onclick="handleNever(true)">Never (N)</button>
            </div>

            <!-- Navigation -->
            <div class="controls nav-controls">
                <button class="btn-next" onclick="nextCard()">Keep & Next (Enter)</button>
            </div>
        `;

      // --- Core Logic: List View ---
      function parseAndRenderList() {
        const input = document.getElementById("csv-input").value;
        cards = parseCSV(input);

        // Apply Sort
        const sortMode = document.getElementById("sort-select").value;
        const stats = getStats();

        if (sortMode !== "csv") {
          cards.sort((a, b) => {
            const sA = stats[a.kanji] || { easy: 0, difficult: 0, again: 0 };
            const sB = stats[b.kanji] || { easy: 0, difficult: 0, again: 0 };

            if (sortMode === "easy") {
              // Descending Easy Count
              return sB.easy - sA.easy;
            } else if (sortMode === "hard") {
              // Descending Difficult + Again
              const hardA = sA.difficult + sA.again;
              const hardB = sB.difficult + sB.again;
              return hardB - hardA;
            }
            return 0;
          });
        }

        const container = document.getElementById("list-container");
        container.innerHTML = "";

        const ignored = getIgnoredCards();

        cards.forEach((card) => {
          const statsStr = getStatString(card.kanji);
          const isIgnored = ignored.includes(card.kanji);
          container.innerHTML += listItemTemplate(card, statsStr, isIgnored);
        });
      }

      // --- Core Logic: Study Session ---
      function startStudySession() {
        parseAndRenderList();

        const ignored = getIgnoredCards();
        studyQueue = cards.filter((c) => !ignored.includes(c.kanji));

        if (studyQueue.length === 0)
          return alert("No cards selected for study!");

        initialSessionCount = studyQueue.length;
        shuffleArray(studyQueue);

        document.getElementById("setup-container").style.display = "none";
        document.getElementById("list-container").style.display = "none";
        document.getElementById("flashcard-container").style.display = "flex";

        renderNextCardSetup();
      }

      function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
      }

      function renderNextCardSetup() {
        if (studyQueue.length === 0) {
          alert("Session Complete!");
          exitStudy();
          return;
        }

        isCardBackVisible = false;
        currentCard = studyQueue[0];
        lastActionState = null;

        const display = document.getElementById("card-display");
        display.innerHTML = cardFrontTemplate(currentCard);
      }

      function nextCard() {
        renderNextCardSetup();
      }

      /**
       * Handles the "Never" button logic.
       * Marks as ignored (future) and Easy (current session).
       */
      function handleNever(isCorrection = false) {
        // 1. Mark as ignored in local storage
        toggleIgnoredCard(currentCard.kanji);

        // 2. Treat as "Easy" for this session
        handleResponse("easy", isCorrection);

        // 3. Update the lastActionState to record that this was a 'never' action
        // We do this after handleResponse to append the specific flag
        if (lastActionState) {
          lastActionState.wasNever = true;
        }
      }

      /**
       * Handles rating the card.
       * @param {string} type - 'easy', 'difficult', or 'again'
       * @param {boolean} isCorrection - If true, we are on the back of the card overwriting the previous choice.
       */
      function handleResponse(type, isCorrection = false) {
        // 1. If this is a correction (clicked on back), UNDO the previous action first
        if (isCorrection && lastActionState) {
          // If the previous state was "Never", we need to un-ignore it before processing the new rating
          if (lastActionState.wasNever) {
            toggleIgnoredCard(lastActionState.card.kanji);
          }

          // Revert stats
          updateStat(lastActionState.card.kanji, lastActionState.type, false);

          // Revert Queue: Remove the card from where it was moved to
          if (lastActionState.insertedAtIndex !== -1) {
            studyQueue.splice(lastActionState.insertedAtIndex, 1);
          }

          // Put the card back at the very front of the queue so we can process it anew
          studyQueue.unshift(lastActionState.card);

          // Reset currentCard to ensure we are acting on the correct object
          currentCard = lastActionState.card;
        }

        // 2. Apply the New Rating (Standard Logic)
        updateStat(currentCard.kanji, type, true);

        // Remove card from head of queue
        const card = studyQueue.shift();
        let insertedAtIndex = -1;

        // Re-insert based on difficulty
        if (type === "difficult") {
          if (studyQueue.length > 0) {
            insertedAtIndex = Math.floor(Math.random() * studyQueue.length) + 1;
            studyQueue.splice(insertedAtIndex, 0, card);
          } else {
            insertedAtIndex = 0;
            studyQueue.push(card);
          }
        } else if (type === "again") {
          const lookahead = Math.min(studyQueue.length, 5);
          insertedAtIndex = Math.floor(Math.random() * (lookahead + 1));
          studyQueue.splice(insertedAtIndex, 0, card);
        }

        // Save state for potential future correction
        lastActionState = {
          card: card,
          type: type,
          insertedAtIndex: insertedAtIndex,
          wasNever: false, // Default to false, handleNever will overwrite if needed
        };

        // 3. Determine Next Step
        if (isCorrection) {
          // If we just corrected on the back, immediately go to next card
          nextCard();
        } else {
          // If this was the first rating (front), show the back
          isCardBackVisible = true;
          const display = document.getElementById("card-display");
          display.innerHTML = cardBackTemplate(currentCard);
        }
      }

      function undoResponse() {
        if (!lastActionState) return;

        // If the action we are undoing was a "Never" action, we must un-ignore the card
        if (lastActionState.wasNever) {
          toggleIgnoredCard(lastActionState.card.kanji);
        }

        updateStat(lastActionState.card.kanji, lastActionState.type, false);

        if (lastActionState.insertedAtIndex !== -1) {
          studyQueue.splice(lastActionState.insertedAtIndex, 1);
        }

        studyQueue.unshift(lastActionState.card);

        isCardBackVisible = false;
        lastActionState = null;
        const display = document.getElementById("card-display");
        display.innerHTML = cardFrontTemplate(currentCard);
      }

      function exitStudy() {
        document.getElementById("flashcard-container").style.display = "none";
        document.getElementById("setup-container").style.display = "block";
        document.getElementById("list-container").style.display = "grid";
        parseAndRenderList();
      }

      // --- Keyboard Shortcuts ---
      document.addEventListener("keydown", (e) => {
        const container = document.getElementById("flashcard-container");
        if (container.style.display !== "flex") return;

        const key = e.key.toLowerCase();

        // Check if we are on the back of the card
        if (isCardBackVisible) {
          // Allow rating keys to trigger correction
          if (key === "e") handleResponse("easy", true);
          if (key === "d") handleResponse("difficult", true);
          if (key === "a") handleResponse("again", true);
          if (key === "n") handleNever(true);

          // Navigation (Note: 'n' removed from here)
          if (key === "enter" || key === " ") {
            e.preventDefault(); // Stop page scrolling on Space
            nextCard();
          }
        } else {
          // Front of card
          if (key === "e") handleResponse("easy");
          if (key === "d") handleResponse("difficult");
          if (key === "a") handleResponse("again");
          if (key === "n") handleNever();
        }

        if (key === "backspace") undoResponse();
      });
      // Start app
      init();
    </script>
  </body>
</html>
