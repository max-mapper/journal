<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calligraphy Kanji Quiz</title>

    <style>
      body {
        background-color: #f0f2f5;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
        user-select: none;
      }

      h1 {
        margin-bottom: 10px;
        color: #333;
      }

      /* Container holds both HanziWriter (bottom) and Calligraphy (top) */
      #canvas-container {
        position: relative;
        width: 415px;
        height: 498px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        background-color: #fff;
        /* Japanese paper texture simulation */
        background-image: radial-gradient(#fff 0%, #f4f1ea 100%);
        cursor: crosshair;
        margin-bottom: 20px;
      }

      /* Hanzi Writer Container - sits at the bottom */
      #character-target {
        position: absolute;
        top: 0;
        left: 0;
        width: 415px;
        height: 498px;
        z-index: 0;
        pointer-events: none;
      }

      /* Calligraphy Canvases - sit on top */
      canvas.calligraphy-layer {
        position: absolute;
        top: 0;
        left: 0;
        touch-action: none;
      }

      #layered-canvas {
        z-index: 1;
      }
      #write-canvas {
        z-index: 2;
        opacity: 1;
      }
      #hand-canvas {
        z-index: 3;
      }

      /* Visual Hand Cursor */
      #hand-image {
        position: absolute;
        width: 20px;
        height: 20px;
        background: rgba(200, 0, 0, 0.5);
        border-radius: 50%;
        pointer-events: none;
        z-index: 10;
        display: none;
        margin-top: -10px;
        margin-left: -10px;
      }

      /* UI Controls */
      .controls {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
        max-width: 450px;
      }

      input[type="text"] {
        padding: 8px;
        font-size: 16px;
        border: 1px solid #ddd;
        border-radius: 4px;
        width: 50px;
        text-align: center;
      }

      button {
        padding: 8px 16px;
        background: #333;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }
      button:hover {
        background: #555;
      }
      button.secondary {
        background-color: #6c757d;
      }
      button.secondary:hover {
        background-color: #545b62;
      }
      button.action {
        background-color: #007bff;
      }
      button.action:hover {
        background-color: #0056b3;
      }

      .status-msg {
        margin-top: 10px;
        font-weight: bold;
        min-height: 24px;
        color: #555;
      }
    </style>
  </head>
  <body>
    <h1>Calligraphy Kanji Quiz</h1>

    <div class="controls">
      <input
        type="text"
        id="kanji-input"
        value="七"
        maxlength="1"
        placeholder="字"
      />
      <button class="action" onclick="loadChar()">Load Kanji</button>
      <button class="secondary" onclick="startQuiz()">Start Quiz</button>
      <button onclick="clearCanvas()">Clear Paper</button>
    </div>

    <div class="status-msg" id="status-text">Load a character to begin.</div>

    <div id="canvas-container">
      <!-- Hanzi Writer Layer -->
      <div id="character-target"></div>

      <!-- Calligraphy Layer -->
      <div id="hand-image"></div>
      <canvas
        id="layered-canvas"
        class="calligraphy-layer"
        width="415"
        height="498"
      ></canvas>
      <canvas
        id="write-canvas"
        class="calligraphy-layer"
        width="415"
        height="498"
      ></canvas>
      <canvas
        id="hand-canvas"
        class="calligraphy-layer"
        width="415"
        height="498"
      ></canvas>
    </div>

    <div class="controls" style="margin-top: 10px">
      <small>Brush Size:</small>
      <button onclick="setBrush('Large')">Large</button>
      <button onclick="setBrush('Medium')">Medium</button>
      <button onclick="setBrush('Small')">Small</button>
    </div>

    <!-- jQuery for Calligraphy -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="text/javascript">
      // Polyfill for jQuery .live()
      jQuery.fn.live = function (types, data, fn) {
        jQuery(this.context).on(types, this.selector, data, fn);
        return this;
      };
    </script>
    <!-- Hanzi Writer library -->
    <script src="hanzi-writer.js"></script>
    <script src="calligraphy.js" type="text/javascript"></script>
    <script src="brushes.js" type="text/javascript"></script>

    <script type="text/javascript">
      let writer = null;
      const CANVAS_WIDTH = 415;
      const CANVAS_HEIGHT = 498;

      // Initialize Calligraphy Engine
      $(document).ready(function () {
        var canvas = $("#write-canvas");
        var canvasE = canvas.get(0);
        var layeredCanvas = $("#layered-canvas");
        var layeredCanvasE = layeredCanvas.get(0);
        var handCanvas = $("#hand-canvas");

        // Set dimensions explicitly just in case
        canvasE.width = CANVAS_WIDTH;
        canvasE.height = CANVAS_HEIGHT;
        layeredCanvasE.width = CANVAS_WIDTH;
        layeredCanvasE.height = CANVAS_HEIGHT;
        handCanvas[0].width = CANVAS_WIDTH;
        handCanvas[0].height = CANVAS_HEIGHT;

        Calligraphy.Writer.Shared.StrokeEngine =
          new Calligraphy.Writer.StrokeEngine(
            canvasE.width,
            canvasE.height,
            canvas,
            layeredCanvasE,
          );

        Calligraphy.Writer.Shared.StrokeManager =
          new Calligraphy.Writer.StrokeManager(
            handCanvas,
            Calligraphy.Writer.Shared.StrokeEngine,
          );

        Calligraphy.Writer.Shared.StrokeManager.isHandVisible = false;
        Calligraphy.Writer.Shared.StrokeManager.start();

        Calligraphy.Writer.Shared.StrokeManager.setBrushOpacity(0.5);
        // Load default char
        loadChar();
      });

      function clearCanvas() {
        Calligraphy.Writer.Shared.StrokeManager.clearHistory();
      }

      function setBrush(name) {
        Calligraphy.Writer.Shared.StrokeManager.selectBrush(name);
      }

      function undo() {
        Calligraphy.Writer.Shared.StrokeManager.undoStroke();
      }

      // Hanzi Writer Integration
      const japaneseCharDataLoader = (char, onComplete, onError) => {
        fetch(
          `https://cdn.jsdelivr.net/npm/kanji-writer-data-jp@latest/${char}.json`,
        )
          .then((res) => {
            if (!res.ok) throw new Error("Character not found");
            return res.json();
          })
          .then(onComplete)
          .catch(onError);
      };

      function loadChar() {
        const char = document.getElementById("kanji-input").value;
        const statusText = document.getElementById("status-text");

        if (!char) return;

        // Reset Calligraphy canvas
        clearCanvas();

        statusText.textContent = "Loading...";
        statusText.style.color = "#555";

        document.getElementById("character-target").innerHTML = ""; // Clear existing writer

        try {
          writer = HanziWriter.create("character-target", char, {
            width: CANVAS_WIDTH,
            height: CANVAS_HEIGHT,
            padding: 20,
            showOutline: true,
            showCharacter: true, // Show initial char
            strokeAnimationSpeed: 1,
            delayBetweenStrokes: 0,
            strokeColor: "#8ac926",
            highlightColor: "#f75b43",
            outlineColor: "#dee0e4",
            drawingColor: "#0a121f",
            drawingWidth: 30, // Make detection area wide
            showHintAfterMisses: 1,
            charDataLoader: japaneseCharDataLoader,
            onLoadCharDataError: (error) => {
              statusText.textContent = "Error: Character not supported.";
              statusText.style.color = "red";
            },
            onLoadCharDataSuccess: () => {
              statusText.textContent = "Loaded! Press 'Start Quiz'.";
              statusText.style.color = "#333";
            },
          });
        } catch (e) {
          statusText.textContent = "Error initializing writer.";
        }
      }

      function startQuiz() {
        if (!writer) return;

        const statusText = document.getElementById("status-text");

        // Clear Calligraphy canvas for fresh start
        clearCanvas();

        // Configure Writer for Quiz
        // We want the writer to be invisible mostly, acting as a logic layer
        writer.hideCharacter();
        writer.showOutline();

        statusText.textContent = "Draw with the brush!";
        statusText.style.color = "#007bff";

        writer.quiz({
          delineateStrokes: true, // Needed for visual feedback on correct strokes if using SVG
          drawingWidth: 40, // Wide tolerance for brush
          onMistake: function (strokeData) {
            statusText.textContent =
              "Mistake on stroke " + (strokeData.strokeNum + 1);
            statusText.style.color = "red";
            // Optional: flash screen or sound
            undo();
          },
          onCorrectStroke: function (strokeData) {
            statusText.textContent =
              "Good! " + strokeData.strokesRemaining + " strokes remaining.";
            statusText.style.color = "green";
          },
          onComplete: function (summaryData) {
            statusText.textContent = `Quiz Complete! Mistakes: ${summaryData.totalMistakes}`;
            statusText.style.color = "#28a745";

            // Optional: Flash the perfect SVG behind the brush strokes
            writer.showCharacter();
          },
        });
      }
    </script>
  </body>
</html>
