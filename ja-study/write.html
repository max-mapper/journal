<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calligraphy Kanji Study</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f0f2f5;
        display: flex;
        flex-direction: column;
        align-items: center;
        user-select: none;
      }

      h1 {
        text-align: center;
        color: #333;
        margin-bottom: 20px;
      }

      /* Setup Section */
      #setup-section {
        display: flex;
        flex-direction: column;
        gap: 15px;
        width: 100%;
        max-width: 600px;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      textarea {
        width: 100%;
        height: 120px;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-family: monospace;
        box-sizing: border-box;
      }

      /* Study Section */
      #study-section {
        display: none;
        flex-direction: column;
        align-items: center;
        width: 100%;
      }

      .info-card {
        height: 150px;
        background: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 450px;
        text-align: center;
        margin-bottom: 20px;
        box-sizing: border-box;
      }

      .word-display {
        font-size: 2em;
        font-weight: bold;
        color: #333;
        margin: 10px 0;
        letter-spacing: 5px;
      }

      .word-display span {
        border-bottom: 1px solid black;
        margin-right: 5px;
      }

      .current-char-highlight {
        color: #fff;
        /* border-bottom: 3px solid #d93025; */
      }

      .pending-char {
        color: #fff;
      }

      .correct {
        color: black;
      }

      .kana-display {
        font-size: 1.2em;
        color: #555;
      }

      .def-display {
        color: #666;
        font-style: italic;
        font-size: 0.9em;
      }

      /* Calligraphy Canvas Container */
      #canvas-container {
        position: relative;
        /* UPDATED: 500x500 Square */
        width: 500px;
        height: 500px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        background-color: #fff;
        /* Japanese paper texture simulation */
        background-image: radial-gradient(#fff 0%, #f4f1ea 100%);
        cursor: crosshair;
        margin-bottom: 15px;
        box-sizing: border-box; /* Ensures border doesn't break layout */
      }

      /* GUIDE LINES STYLES */
      #canvas-container.show-guides {
        border: 2px solid #007bff; /* Blue Outline */
      }

      /* Vertical Dotted Line */
      #canvas-container.show-guides::before {
        content: "";
        position: absolute;
        top: 0;
        bottom: 0;
        left: 50%;
        border-left: 2px dashed #89cff0; /* Light blue dashed */
        transform: translateX(-50%);
        pointer-events: none;
        z-index: 1; /* Above background, below canvas */
      }

      /* Horizontal Dotted Line */
      #canvas-container.show-guides::after {
        content: "";
        position: absolute;
        left: 0;
        right: 0;
        top: 50%;
        border-top: 2px dashed #89cff0; /* Light blue dashed */
        transform: translateY(-50%);
        pointer-events: none;
        z-index: 1;
      }

      /* Hanzi Writer Layer (Bottom, Logic) */
      #character-target {
        position: absolute;
        top: 0;
        left: 0;
        /* UPDATED: 500x500 */
        width: 500px;
        height: 500px;
        z-index: 0;
        pointer-events: none;
      }

      /* Calligraphy Layers (Top, Visual) */
      canvas.calligraphy-layer {
        position: absolute;
        top: 0;
        left: 0;
        touch-action: none;
      }

      #layered-canvas {
        z-index: 2;
      }
      #write-canvas {
        z-index: 3;
        opacity: 1;
      }
      #hand-canvas {
        z-index: 4;
      }

      /* Visual Hand Cursor */
      #hand-image {
        position: absolute;
        width: 20px;
        height: 20px;
        background: rgba(200, 0, 0, 0.5);
        border-radius: 50%;
        pointer-events: none;
        z-index: 10;
        display: none;
        margin-top: -10px;
        margin-left: -10px;
      }

      /* Controls */
      .controls {
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
        width: 100%;
        max-width: 500px;
        align-items: center;
      }

      .controls label {
        display: flex;
        align-items: center;
        gap: 5px;
        font-weight: bold;
        color: #555;
        cursor: pointer;
        background: #e9ecef;
        padding: 5px 10px;
        border-radius: 5px;
      }

      button {
        padding: 10px 15px;
        background-color: #333;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.2s;
      }
      button:hover {
        background-color: #555;
      }

      button.primary {
        background-color: #007bff;
      }
      button.primary:hover {
        background-color: #0056b3;
      }

      button.secondary {
        background-color: #6c757d;
      }
      button.secondary:hover {
        background-color: #545b62;
      }

      #status-text {
        min-height: 24px;
        font-weight: bold;
        color: #007bff;
        margin-top: 5px;
      }
    </style>
  </head>
  <body>
    <h1>Calligraphy Kanji Practice</h1>

    <!-- SECTION 1: DATA INPUT -->
    <div id="setup-section">
      <p>
        Paste your CSV data below (level, kanji, furigana, definition, kana):
      </p>
      <textarea
        id="csv-input"
        placeholder='"1","時間","じかん","time","じかん"...'
      >
"1","時間","じかん","time","じかん"
"1","国","くに","country","くに"
"1","出す","だ","to take out / to submit","だす"
"1","外国","がいこく","foreign country","がいこく"
</textarea
      >
      <button class="primary" onclick="startStudy()">Start Studying</button>
    </div>

    <!-- SECTION 2: STUDY INTERFACE -->
    <div id="study-section">
      <div class="info-card">
        <div class="kana-display" id="question-kana"></div>
        <!-- This displays the word with the active character highlighted -->
        <div class="word-display" id="word-progress-display"></div>
        <div class="def-display" id="question-def"></div>
        <div id="status-text"></div>
      </div>

      <div id="canvas-container">
        <!-- Hanzi Writer Layer -->
        <div id="character-target"></div>

        <!-- Calligraphy Layers -->
        <div id="hand-image"></div>
        <!-- UPDATED: Canvas Dimensions 500x500 -->
        <canvas
          id="layered-canvas"
          class="calligraphy-layer"
          width="500"
          height="500"
        ></canvas>
        <canvas
          id="write-canvas"
          class="calligraphy-layer"
          width="500"
          height="500"
        ></canvas>
        <canvas
          id="hand-canvas"
          class="calligraphy-layer"
          width="500"
          height="500"
        ></canvas>
      </div>

      <div class="controls">
        <!-- <button class="secondary" onclick="clearCurrentCanvas()">
          Clear Canvas
        </button> -->
        <button class="secondary" onclick="toggleOutline()">Hint</button>
        <!-- <button class="secondary" onclick="undoStroke()">Undo</button> -->
        <div style="width: 10px"></div>
        <!-- Spacer -->

        <button onclick="setBrush('SmallMed')">Small Brush</button>
        <button onclick="setBrush('Medium')">Medium Brush</button>
        <button onclick="setBrush('Large')">Large Brush</button>
        <label>
          <input
            type="checkbox"
            id="guide-toggle"
            onchange="toggleGuides()"
            checked
          />
          Guides
        </label>
      </div>

      <div
        class="controls"
        style="margin-top: 15px; border-top: 1px solid #ddd; padding-top: 15px"
      >
        <button
          id="next-btn"
          class="primary"
          style="display: none"
          onclick="nextWord()"
        >
          Next Word
        </button>
        <!-- <button class="secondary" onclick="restart()">Exit / Restart</button> -->
      </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paper.js/0.12.17/paper-full.min.js"></script>
    <!-- Offset Extension (Handles the complex math) -->
    <script src="paper-offset.js"></script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="text/javascript">
      // Polyfill for jQuery .live() used by older plugins
      jQuery.fn.live = function (types, data, fn) {
        jQuery(this.context).on(types, this.selector, data, fn);
        return this;
      };
    </script>

    <!-- Hanzi Writer -->
    <script src="hanzi-writer.js"></script>
    <script src="calligraphy.js" type="text/javascript"></script>
    <script src="brushes.js" type="text/javascript"></script>
    <script src="kanjivg-loader.js" type="text/javascript"></script>

    <script>
      // --- Constants ---
      // UPDATED: 500x500
      const CANVAS_WIDTH = 500;
      const CANVAS_HEIGHT = 500;

      // --- State Management ---
      let studyList = [];
      let currentWordIndex = 0;
      let currentWordData = null;
      let currentKanjiArray = [];
      let currentKanjiIndex = 0;
      let writer = null;

      // --- Guide Toggle ---
      function toggleGuides() {
        const container = document.getElementById("canvas-container");
        const checkbox = document.getElementById("guide-toggle");
        if (checkbox.checked) {
          container.classList.add("show-guides");
        } else {
          container.classList.remove("show-guides");
        }
      }

      // --- Calligraphy Initialization ---
      function initCalligraphy() {
        var canvas = $("#write-canvas");
        var layeredCanvas = $("#layered-canvas");
        var handCanvas = $("#hand-canvas");

        var canvasE = canvas.get(0);
        var layeredCanvasE = layeredCanvas.get(0);

        // Ensure sizes
        canvasE.width = CANVAS_WIDTH;
        canvasE.height = CANVAS_HEIGHT;
        layeredCanvasE.width = CANVAS_WIDTH;
        layeredCanvasE.height = CANVAS_HEIGHT;
        handCanvas[0].width = CANVAS_WIDTH;
        handCanvas[0].height = CANVAS_HEIGHT;

        try {
          Calligraphy.Writer.Shared.StrokeEngine =
            new Calligraphy.Writer.StrokeEngine(
              canvasE.width,
              canvasE.height,
              canvas,
              layeredCanvasE,
            );

          Calligraphy.Writer.Shared.StrokeManager =
            new Calligraphy.Writer.StrokeManager(
              handCanvas,
              Calligraphy.Writer.Shared.StrokeEngine,
            );

          Calligraphy.Writer.Shared.StrokeManager.isHandVisible = false;
          Calligraphy.Writer.Shared.StrokeManager.start();
          Calligraphy.Writer.Shared.StrokeManager.setBrushOpacity(0.5);
        } catch (e) {
          console.error(
            "Calligraphy engine failed to load. Check if calligraphy.js is present.",
            e,
          );
          document.getElementById("status-text").textContent =
            "Error loading Calligraphy engine.";
        }
      }

      function clearCurrentCanvas() {
        if (Calligraphy.Writer.Shared.StrokeManager) {
          Calligraphy.Writer.Shared.StrokeManager.clearHistory();
        }
        // If the writer has specific internal state to reset:
        if (writer) {
          startQuizForCurrentChar();
        }
      }

      function toggleOutline() {
        writer.showOutline();
        setTimeout(() => {
          writer.hideOutline();
        }, 1000);
      }

      function undoStroke() {
        if (Calligraphy.Writer.Shared.StrokeManager) {
          Calligraphy.Writer.Shared.StrokeManager.undoStroke();
        }
      }

      function setBrush(name) {
        if (Calligraphy.Writer.Shared.StrokeManager) {
          Calligraphy.Writer.Shared.StrokeManager.selectBrush(name);
        }
      }

      // --- CSV Parsing ---
      function parseCSV(text) {
        const lines = text.trim().split("\n");
        const data = [];
        const parseLine = (line) => {
          const result = [];
          let current = "";
          let inQuote = false;
          for (let i = 0; i < line.length; i++) {
            const char = line[i];
            if (char === '"') inQuote = !inQuote;
            else if (char === "," && !inQuote) {
              result.push(current);
              current = "";
            } else current += char;
          }
          result.push(current);
          return result;
        };

        lines.forEach((line) => {
          if (!line.trim()) return;
          const cols = parseLine(line).map((c) => c.trim());
          if (cols.length >= 5 && cols[0] !== "level") {
            data.push({
              level: cols[0],
              kanji: cols[1],
              furigana: cols[2],
              def: cols[3],
              kana: cols[4],
            });
          }
        });
        return data;
      }

      // --- Study Logic ---

      function startStudy() {
        const input = document.getElementById("csv-input").value;
        studyList = parseCSV(input);
        if (studyList.length === 0) {
          alert("No valid words found.");
          return;
        }

        // Shuffle
        studyList.sort(() => Math.random() - 0.5);
        currentWordIndex = 0;

        document.getElementById("setup-section").style.display = "none";
        document.getElementById("study-section").style.display = "flex";

        initCalligraphy();
        toggleGuides();
        loadWord();
      }

      function restart() {
        document.getElementById("setup-section").style.display = "flex";
        document.getElementById("study-section").style.display = "none";
      }

      function loadWord() {
        if (currentWordIndex >= studyList.length) {
          alert("Session Complete!");
          // restart();
          return;
        }

        currentWordData = studyList[currentWordIndex];
        // Split word into array of characters
        currentKanjiArray = currentWordData.kanji.split("");
        currentKanjiIndex = 0;

        // UI Setup
        document.getElementById("question-kana").textContent =
          currentWordData.kana;
        document.getElementById("next-btn").style.display = "none";

        updateWordProgress();
        loadCurrentKanji();
      }

      function updateWordProgress() {
        const container = document.getElementById("word-progress-display");
        container.innerHTML = "";

        currentKanjiArray.forEach((char, idx) => {
          const span = document.createElement("span");
          span.textContent = char;
          if (idx < currentKanjiIndex) {
            span.className = "correct"; // Completed
          } else if (idx === currentKanjiIndex) {
            span.className = "current-char-highlight"; // Active
          } else {
            span.className = "pending-char"; // Future
          }
          container.appendChild(span);
        });
      }

      const kanjiVGCharDataLoader = (char, onComplete, onError) => {
        // Get the code point of the first character to handle surrogate pairs correctly
        const codePoint = char.codePointAt(0);

        // Convert to hexadecimal, ensure lower case, and pad with zeros to 5 digits
        let filename = codePoint.toString(16).toLowerCase().padStart(5, "0");
        fetch(`kanji/${filename}.svg`)
          .then(async (res) => {
            if (!res.ok) throw new Error("Character not found");
            let svg = await res.text();
            console.log("svg", svg);
            let json = processKanjiSVG(svg);
            console.log("json", json);
            let buffered = bufferObjectStrokes(json);
            console.log("buffered", buffered);
            return buffered;
          })
          .then(onComplete);
        // .catch(onError);
      };

      // Hanzi Writer Data Loader
      const japaneseCharDataLoader = (char, onComplete, onError) => {
        fetch(
          `https://cdn.jsdelivr.net/npm/kanji-writer-data-jp@latest/${char}.json`,
        )
          .then((res) => {
            if (!res.ok) throw new Error("Character not found");
            return res.json();
          })
          .then(onComplete)
          .catch(onError);
      };

      function loadCurrentKanji() {
        if (currentKanjiIndex >= currentKanjiArray.length) {
          // Word Complete
          document.getElementById("status-text").textContent = "Word Complete!";
          document.getElementById("status-text").style.color = "green";
          // UPDATED: Auto advance after 1 second
          setTimeout(nextWord, 1000);
          return;
        }

        const char = currentKanjiArray[currentKanjiIndex];
        const statusEl = document.getElementById("status-text");

        // Clear Canvas for new char
        if (Calligraphy.Writer.Shared.StrokeManager) {
          Calligraphy.Writer.Shared.StrokeManager.clearHistory();
        }

        document.getElementById("character-target").innerHTML = "";

        statusEl.textContent = "Loading ...";
        statusEl.style.color = "#555";

        writer = HanziWriter.create("character-target", char, {
          charDataLoader: kanjiVGCharDataLoader,
          width: CANVAS_WIDTH,
          height: CANVAS_HEIGHT,
          padding: 20,
          showOutline: false,
          showCharacter: false,
          strokeAnimationSpeed: 1,
          delayBetweenStrokes: 0,
          strokeColor: "#8ac926",
          highlightColor: "#f75b43",
          outlineColor: "#dee0e4",
          drawingColor: "#fff",
          drawingFadeDuration: 0,
          drawingWidth: 1,
          showHintAfterMisses: 3,
          onLoadCharDataError: (err) => {
            console.log("Skipping character (not found): " + char);
            // Auto-advance if character data isn't found
            currentKanjiIndex++;
            updateWordProgress();
            loadCurrentKanji();
          },
          onLoadCharDataSuccess: () => {
            startQuizForCurrentChar();
          },
        });
      }

      function startQuizForCurrentChar() {
        const statusEl = document.getElementById("status-text");
        statusEl.textContent = "";

        writer.quiz({
          delineateStrokes: true,
          drawingWidth: 50,
          onMistake: function (strokeData) {
            statusEl.textContent =
              "Mistake on stroke " + (strokeData.strokeNum + 1);
            statusEl.style.color = "orange";
            undoStroke();
          },
          onCorrectStroke: function (strokeData) {
            statusEl.textContent =
              "Correct! (" + strokeData.strokesRemaining + " remaining)";
            statusEl.style.color = "#007bff";
          },
          onComplete: function (summaryData) {
            statusEl.textContent = "Correct!";
            statusEl.style.color = "green";

            // Advance to next char after short delay
            setTimeout(() => {
              currentKanjiIndex++;
              updateWordProgress();
              loadCurrentKanji();
            }, 800);
          },
        });
      }

      function nextWord() {
        currentWordIndex++;
        loadWord();
      }
    </script>
  </body>
</html>
