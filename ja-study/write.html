<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calligraphy Kanji Study</title>
    <link rel="stylesheet" type="text/css" href="style.css" />
  </head>
  <body>
    <h1>Calligraphy Kanji Practice</h1>

    <!-- SECTION 1: SETUP -->
    <div id="setup-section">
      <div class="setup-row">
        <label
          >Load Preset:
          <select id="preset-list" onchange="loadPreset()">
            <option value="example">Grade 1 Kanji Words</option>
            <option value="custom">Custom (Paste below)</option>
          </select>
        </label>
      </div>
      <div class="setup-row">
        <label
          >Mode:
          <select id="mode-select">
            <option value="1">Review (1x)</option>
            <option value="10">Learning (10x)</option>
          </select>
        </label>
        <label> <input type="checkbox" id="shuffle" /> Shuffle </label>
        <label> <input type="checkbox" id="write-kana" /> Write Kana </label>
      </div>
      <p>Data (CSV: tags, kanji, readings, definition):</p>
      <textarea id="csv-input"></textarea>
      <button class="primary" onclick="startStudy()">Start Studying</button>
    </div>

    <!-- SECTION 2: STUDY INTERFACE -->
    <div id="study-section">
      <div id="stats-bar">
        <div class="stat-item">
          <span id="stat-progress">0/0</span>
        </div>
      </div>

      <div class="info-card">
        <div class="kana-display" id="question-kana"></div>
        <div class="word-display" id="word-progress-display"></div>
        <div class="def-display" id="question-def"></div>
        <div id="status-text"></div>
        <div id="repetition-text" style="font-size: 0.8em; color: #999"></div>
      </div>

      <div id="canvas-container">
        <div id="character-target"></div>
        <div id="hand-image"></div>
        <canvas
          id="layered-canvas"
          class="calligraphy-layer"
          width="350"
          height="350"
        ></canvas>
        <canvas
          id="write-canvas"
          class="calligraphy-layer"
          width="350"
          height="350"
        ></canvas>
        <canvas
          id="hand-canvas"
          class="calligraphy-layer"
          width="350"
          height="350"
        ></canvas>
      </div>

      <div class="controls">
        <button class="secondary" onclick="toggleOutline(writer)">Hint</button>
        <div style="width: 10px"></div>
        <button onclick="setBrush('Small')">Small</button>
        <button onclick="setBrush('SmallMed')">Medium</button>
        <button onclick="setBrush('Large')">Large</button>
        <label>
          <input
            type="checkbox"
            id="guide-toggle"
            onchange="toggleGuides()"
            checked
          />
          Guides
        </label>
      </div>

      <div
        class="controls"
        style="margin-top: 15px; border-top: 1px solid #ddd; padding-top: 15px"
      >
        <button id="back-btn" class="danger" onclick="prevWord()">
          Back (Redo Word)
        </button>
        <button id="skip-btn" class="secondary" onclick="skipWord()">
          Skip Word
        </button>
        <button class="secondary" onclick="restart()">Exit</button>
      </div>
    </div>

    <!-- SECTION 3: REVIEW / FINISH -->
    <div id="review-section">
      <h2 id="review-title">Review</h2>
      <div id="review-grid" class="review-grid">
        <!-- Cards go here -->
      </div>
      <button
        class="primary"
        id="review-continue-btn"
        onclick="continueFromReview()"
      >
        Continue
      </button>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paper.js/0.12.17/paper-full.min.js"></script>
    <script src="paper-offset.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="text/javascript">
      jQuery.fn.live = function (types, data, fn) {
        jQuery(this.context).on(types, this.selector, data, fn);
        return this;
      };
    </script>
    <script src="hanzi-writer.js"></script>
    <script src="calligraphy.js" type="text/javascript"></script>
    <script src="brushes.js" type="text/javascript"></script>
    <script src="kanjivg-loader.js" type="text/javascript"></script>

    <!-- Externalized Utilities -->
    <script src="app-utils.js"></script>

    <script>
      // --- Constants ---
      const CANVAS_WIDTH = 350;
      const CANVAS_HEIGHT = 350;

      // --- State ---
      let studyList = [];
      let currentWordIndex = 0;
      let sessionResults = {}; // Map wordIndex -> { perfect: bool, mistakes: int }
      let stats = { perfect: 0, imperfect: 0 };

      let currentKanjiArray = [];
      let currentKanjiIndex = 0;
      let writer = null;

      // Settings
      let repetitionGoal = 1;
      let isStrictMode = false;
      let isShuffling = false;
      let writeKanaEnabled = false;
      let currentRepetition = 0;
      let currentCharMistakes = 0;
      let currentWordHasMistake = false;

      // --- Initialization ---
      window.onload = function () {
        document.getElementById("csv-input").value = EXAMPLE_CSV;
      };

      // --- Study Flow ---
      function startStudy() {
        const input = document.getElementById("csv-input").value;
        studyList = parseCSV(input);
        if (studyList.length === 0) {
          alert("No valid words.");
          return;
        }

        repetitionGoal = parseInt(document.getElementById("mode-select").value);
        isShuffling = document.getElementById("shuffle").checked;
        writeKanaEnabled = document.getElementById("write-kana").checked;

        if (isShuffling) studyList = studyList.sort(() => Math.random() - 0.5);

        stats = { perfect: 0, imperfect: 0 };
        sessionResults = {};
        updateStatsUI(stats, currentWordIndex, studyList.length);

        currentWordIndex = 0;

        document.getElementById("setup-section").style.display = "none";
        document.getElementById("study-section").style.display = "flex";
        document.getElementById("review-section").style.display = "none";

        initCalligraphy(CANVAS_WIDTH, CANVAS_HEIGHT);
        toggleGuides();
        loadWord();
      }

      function prevWord() {
        if (currentWordIndex > 0) {
          currentWordIndex--;
          if (sessionResults[currentWordIndex]) {
            if (sessionResults[currentWordIndex].perfect) stats.perfect--;
            else stats.imperfect--;
            delete sessionResults[currentWordIndex];
          }
          updateStatsUI(stats, currentWordIndex, studyList.length);
          loadWord();
        }
      }

      function skipWord() {
        if (currentWordIndex < studyList.length) {
          stats.imperfect++;
          sessionResults[currentWordIndex] = {
            perfect: false,
            word: studyList[currentWordIndex],
          };
          currentWordIndex++;
          updateStatsUI(stats, currentWordIndex, studyList.length);
          loadWord();
        }
      }

      function loadWord() {
        // Toggle Back Button
        const backBtn = document.getElementById("back-btn");
        backBtn.style.display =
          currentWordIndex === 0 ? "none" : "inline-block";

        // Check Review Interval
        if (
          currentWordIndex > 0 &&
          currentWordIndex % 10 === 0 &&
          !sessionResults["reviewed_" + currentWordIndex]
        ) {
          showReviewScreen(false, currentWordIndex, studyList, sessionResults);
          sessionResults["reviewed_" + currentWordIndex] = true;
          return;
        }

        if (currentWordIndex >= studyList.length) {
          showReviewScreen(true, currentWordIndex, studyList, sessionResults);
          return;
        }

        const data = studyList[currentWordIndex];
        currentWordHasMistake = false;

        let kanaHtml = "";
        if (data.readingRaw.includes("|")) {
          const parts = data.readingRaw.split("|");
          kanaHtml = "";
          for (let p of parts) {
            kanaHtml += `<span>${p}</span>`;
          }
        } else {
          kanaHtml = data.readingRaw;
        }

        document.getElementById("question-kana").innerHTML = kanaHtml;
        document.getElementById("question-def").textContent = data.def;
        document
          .querySelector(".def-display")
          .classList.remove("def-display-show");
        document.getElementById("status-text").textContent = "";

        currentKanjiArray = data.kanji.split("");
        currentKanjiIndex = 0;

        updateWordProgress(currentKanjiArray, currentKanjiIndex);
        loadCurrentKanji();
        updateStatsUI(stats, currentWordIndex, studyList.length);
      }

      function loadCurrentKanji() {
        if (currentKanjiIndex >= currentKanjiArray.length) {
          // Word Done
          if (currentWordHasMistake) stats.imperfect++;
          else stats.perfect++;

          sessionResults[currentWordIndex] = {
            perfect: !currentWordHasMistake,
            word: studyList[currentWordIndex],
          };

          document.getElementById("status-text").textContent = "Word Complete!";

          // Add pause before next word
          setTimeout(() => {
            currentWordIndex++;
            loadWord();
          }, 4000);
          return;
        }

        const char = currentKanjiArray[currentKanjiIndex];

        // Skip Kana if setting is unchecked
        if (!writeKanaEnabled && isKana(char)) {
          currentKanjiIndex++;
          updateWordProgress(currentKanjiArray, currentKanjiIndex);
          loadCurrentKanji();
          return;
        }

        currentRepetition = 0;
        setupWriter(char);
      }

      function continueFromReview() {
        document.getElementById("review-section").style.display = "none";
        document.getElementById("study-section").style.display = "flex";
        loadWord();
      }

      // --- Quiz Logic & Writer Setup ---

      const kanjiVGCharDataLoader = (char, onComplete, onError) => {
        const codePoint = char.codePointAt(0);
        let filename = codePoint.toString(16).toLowerCase().padStart(5, "0");
        if (isKana(char)) {
          // hiragana is broken from kanjivg
          fetch(
            `https://cdn.jsdelivr.net/npm/kanji-writer-data-jp@latest/${char}.json`,
          )
            .then((r) => r.json())
            .then(onComplete);
          return;
        }
        fetch(`kanji/${filename}.svg`)
          .then(async (res) => {
            if (!res.ok) throw new Error("Not found");
            let svg = await res.text();
            let json = processKanjiSVG(svg);
            return bufferObjectStrokes(json);
          })
          .then(onComplete)
          .catch(onError);
      };

      function setupWriter(char) {
        document
          .querySelector(".def-display")
          .classList.remove("def-display-show");
        clearCanvas();
        document.getElementById("character-target").innerHTML = "";
        document.getElementById("status-text").textContent = "Loading...";

        let showOutline = false;
        if (repetitionGoal > 1 && currentRepetition < 4) {
          showOutline = true;
        }

        document.getElementById("repetition-text").innerText =
          repetitionGoal > 1
            ? `Repetition: ${currentRepetition + 1} / ${repetitionGoal}`
            : "";

        writer = HanziWriter.create("character-target", char, {
          charDataLoader: kanjiVGCharDataLoader,
          width: CANVAS_WIDTH,
          height: CANVAS_HEIGHT,
          padding: 20,
          showOutline: showOutline,
          showCharacter: true,
          strokeAnimationSpeed: 1,
          strokeFadeDuration: 1,
          strokeHighlightSpeed: 1,
          highlightOnComplete: false,
          delayBetweenStrokes: 0,
          strokeColor: "#fff",
          highlightColor: "#dee0e4",
          outlineColor: "#dee0e4",
          drawingColor: "#fff",
          drawingFadeDuration: 0,
          showHintAfterMisses: 3,
          averageDistanceThreshold: 400,
          onLoadCharDataError: () => {
            console.log("Failed to load data for " + char);
            currentKanjiIndex++;
            updateWordProgress(currentKanjiArray, currentKanjiIndex);
            loadCurrentKanji();
          },
          onLoadCharDataSuccess: () => {
            runQuiz();
          },
        });
      }

      function runQuiz() {
        const statusEl = document.getElementById("status-text");
        statusEl.textContent = "";
        currentCharMistakes = 0;
        let strictResetTriggered = false;

        writer.quiz({
          delineateStrokes: true,
          onMistake: function (strokeData) {
            statusEl.textContent = "Mistake!";
            statusEl.style.color = "orange";
            undoStroke();
            currentCharMistakes++;
            currentWordHasMistake = true;

            if (isStrictMode && !strictResetTriggered) {
              strictResetTriggered = true;
              statusEl.textContent = "Strict Mode: Resetting character...";
              writer.cancelQuiz();

              setTimeout(() => {
                setupWriter(currentKanjiArray[currentKanjiIndex]);
              }, 1000);
            }
          },
          onCorrectStroke: function (d) {
            console.log("correct", d);
            if (strictResetTriggered) return;
            statusEl.textContent = "Good";
            statusEl.style.color = "#007bff";
            // writer.highlightStroke(d.strokeNum);
          },
          onComplete: function (d) {
            if (strictResetTriggered) return;

            statusEl.textContent = "Correct!";
            statusEl.style.color = "green";
            writer.updateColor("strokeColor", "#8ac926");

            setTimeout(() => {
              currentRepetition++;
              if (currentRepetition < repetitionGoal) {
                setupWriter(currentKanjiArray[currentKanjiIndex]);
              } else {
                document
                  .querySelector(".def-display")
                  .classList.add("def-display-show");
                currentKanjiIndex++;
                updateWordProgress(currentKanjiArray, currentKanjiIndex);
                loadCurrentKanji();
              }
            }, 500);
          },
        });
      }
    </script>
  </body>
</html>
