<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calligraphy Kanji Study</title>
    <!-- Keep CSS styles here or move to style.css if you prefer -->
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f0f2f5;
        display: flex;
        flex-direction: column;
        align-items: center;
        user-select: none;
      }

      h1 {
        text-align: center;
        color: #333;
        margin-bottom: 20px;
      }

      /* Setup Section */
      #setup-section {
        display: flex;
        flex-direction: column;
        gap: 15px;
        width: 100%;
        max-width: 600px;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      .setup-row {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }

      textarea {
        width: 100%;
        height: 120px;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-family: monospace;
        box-sizing: border-box;
      }

      select,
      input[type="number"] {
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #ccc;
      }

      /* Study Section */
      #study-section {
        display: none;
        flex-direction: column;
        align-items: center;
        width: 100%;
        position: relative;
      }

      /* Stats Overlay */
      #stats-bar {
        position: absolute;
        top: 0;
        left: 0;
        background: rgba(255, 255, 255, 0.9);
        padding: 10px;
        border-radius: 0 0 8px 0;
        box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
        font-size: 0.9em;
        z-index: 100;
        display: flex;
        flex-direction: column;
        gap: 5px;
      }
      .stat-item {
        display: flex;
        justify-content: space-between;
        gap: 10px;
      }
      .stat-label {
        font-weight: bold;
        color: #555;
      }
      .stat-val-perfect {
        color: green;
      }
      .stat-val-imperfect {
        color: orange;
      }

      .info-card {
        min-height: 160px;
        background: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 450px;
        text-align: center;
        margin-bottom: 20px;
        box-sizing: border-box;
      }

      .word-display {
        font-size: 2.5em;
        font-weight: bold;
        color: #333;
        margin: 10px 0;
        letter-spacing: 5px;
      }

      .word-display span {
        border-bottom: 3px solid #ababab;
        margin-right: 5px;
        padding-bottom: 5px;
        display: inline-block;
      }

      .kana-char {
        color: #ccc !important;
      }

      .current-char-highlight {
        border-bottom: 2px solid #007bff !important;
        color: white;
      }

      .pending-char {
        color: white;
      }

      .correct {
        color: #333 !important;
      }

      .kana-display {
        font-size: 1.2em;
        color: #555;
      }

      .kana-accent {
        color: #007bff;
      }

      .def-display {
        color: #666;
        font-style: italic;
        font-size: 0.9em;
        margin-top: 5px;
      }

      /* Calligraphy Canvas Container */
      #canvas-container {
        position: relative;
        width: 350px;
        height: 350px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        background-color: #fff;
        /* background-image: radial-gradient(#fff 0%, #f4f1ea 100%); */
        cursor: crosshair;
        margin-bottom: 15px;
        box-sizing: border-box;
      }

      /* GUIDE LINES STYLES */
      #canvas-container.show-guides {
        border: 2px solid #007bff;
      }

      #canvas-container.show-guides::before {
        content: "";
        position: absolute;
        top: 0;
        bottom: 0;
        left: 50%;
        border-left: 2px dashed #89cff0;
        transform: translateX(-50%);
        pointer-events: none;
        z-index: 1;
      }

      #canvas-container.show-guides::after {
        content: "";
        position: absolute;
        left: 0;
        right: 0;
        top: 50%;
        border-top: 2px dashed #89cff0;
        transform: translateY(-50%);
        pointer-events: none;
        z-index: 1;
      }

      #character-target {
        position: absolute;
        top: 0;
        left: 0;
        width: 350px;
        height: 350px;
        z-index: 0;
        pointer-events: none;
      }

      canvas.calligraphy-layer {
        position: absolute;
        top: 0;
        left: 0;
        touch-action: none;
      }

      #layered-canvas {
        z-index: 2;
      }
      #write-canvas {
        z-index: 3;
        opacity: 1;
      }
      #hand-canvas {
        z-index: 4;
      }

      #hand-image {
        position: absolute;
        width: 20px;
        height: 20px;
        background: rgba(200, 0, 0, 0.5);
        border-radius: 50%;
        pointer-events: none;
        z-index: 10;
        display: none;
        margin-top: -10px;
        margin-left: -10px;
      }

      .controls {
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
        width: 100%;
        max-width: 500px;
        align-items: center;
      }

      .controls label {
        display: flex;
        align-items: center;
        gap: 5px;
        font-weight: bold;
        color: #555;
        cursor: pointer;
        background: #e9ecef;
        padding: 5px 10px;
        border-radius: 5px;
      }

      button {
        padding: 10px 15px;
        background-color: #333;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.2s;
      }
      button:hover {
        background-color: #555;
      }
      button.primary {
        background-color: #007bff;
      }
      button.primary:hover {
        background-color: #0056b3;
      }
      button.secondary {
        background-color: #6c757d;
      }
      button.secondary:hover {
        background-color: #545b62;
      }
      button.danger {
        background-color: #dc3545;
      }
      button.danger:hover {
        background-color: #a71d2a;
      }

      #status-text {
        min-height: 24px;
        font-weight: bold;
        color: #007bff;
        margin-top: 5px;
      }

      /* Review Screen */
      #review-section {
        display: none;
        flex-direction: column;
        align-items: center;
        width: 100%;
        max-width: 800px;
      }

      .review-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
        width: 100%;
        margin-bottom: 20px;
      }

      .review-card {
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        text-align: center;
        cursor: pointer;
        transition: transform 0.2s;
        border-bottom: 3px solid transparent;
      }
      .review-card:hover {
        transform: translateY(-2px);
      }
      .review-card.perfect {
        border-bottom-color: green;
      }
      .review-card.imperfect {
        border-bottom-color: orange;
      }

      .review-kanji {
        font-size: 2em;
        font-weight: bold;
        color: #333;
      }
      .review-reading {
        color: #555;
        font-size: 0.9em;
      }
      .review-def {
        color: #888;
        font-size: 0.8em;
        font-style: italic;
        margin-top: 5px;
      }
      .review-stats {
        margin-top: 5px;
        font-size: 0.8em;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h1>Calligraphy Kanji Practice</h1>

    <!-- SECTION 1: SETUP -->
    <div id="setup-section">
      <div class="setup-row">
        <label
          >Load Preset:
          <select id="preset-list" onchange="loadPreset()">
            <option value="example">Grade 1 Kanji Words</option>
            <option value="custom">Custom (Paste below)</option>
          </select>
        </label>
      </div>
      <div class="setup-row">
        <label
          >Mode:
          <select id="mode-select">
            <option value="1">Review (1x)</option>
            <option value="10">Learning (10x)</option>
          </select>
        </label>
        <label> <input type="checkbox" id="strict-mode" /> Strict Mode </label>
        <label> <input type="checkbox" id="write-kana" /> Write Kana </label>
      </div>
      <p>Data (CSV: tags, kanji, readings, definition):</p>
      <textarea id="csv-input"></textarea>
      <button class="primary" onclick="startStudy()">Start Studying</button>
    </div>

    <!-- SECTION 2: STUDY INTERFACE -->
    <div id="study-section">
      <div id="stats-bar">
        <!-- <div class="stat-item">
          <span class="stat-label">Perfect:</span>
          <span class="stat-val-perfect" id="stat-perfect">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Review:</span>
          <span class="stat-val-imperfect" id="stat-imperfect">0</span>
        </div> -->
        <div class="stat-item">
          <!-- <span class="stat-label"></span> -->
          <span id="stat-progress">0/0</span>
        </div>
      </div>

      <div class="info-card">
        <div class="kana-display" id="question-kana"></div>
        <div class="word-display" id="word-progress-display"></div>
        <div class="def-display" id="question-def"></div>
        <div id="status-text"></div>
        <div id="repetition-text" style="font-size: 0.8em; color: #999"></div>
      </div>

      <div id="canvas-container">
        <div id="character-target"></div>
        <div id="hand-image"></div>
        <canvas
          id="layered-canvas"
          class="calligraphy-layer"
          width="350"
          height="350"
        ></canvas>
        <canvas
          id="write-canvas"
          class="calligraphy-layer"
          width="350"
          height="350"
        ></canvas>
        <canvas
          id="hand-canvas"
          class="calligraphy-layer"
          width="350"
          height="350"
        ></canvas>
      </div>

      <div class="controls">
        <button class="secondary" onclick="toggleOutline(writer)">Hint</button>
        <div style="width: 10px"></div>
        <button onclick="setBrush('Small')">Small</button>
        <button onclick="setBrush('SmallMed')">Medium</button>
        <button onclick="setBrush('Large')">Large</button>
        <label>
          <input
            type="checkbox"
            id="guide-toggle"
            onchange="toggleGuides()"
            checked
          />
          Guides
        </label>
      </div>

      <div
        class="controls"
        style="margin-top: 15px; border-top: 1px solid #ddd; padding-top: 15px"
      >
        <button id="back-btn" class="danger" onclick="prevWord()">
          Back (Redo Word)
        </button>
        <button id="skip-btn" class="secondary" onclick="skipWord()">
          Skip Word
        </button>
        <button class="secondary" onclick="restart()">Exit</button>
      </div>
    </div>

    <!-- SECTION 3: REVIEW / FINISH -->
    <div id="review-section">
      <h2 id="review-title">Review</h2>
      <div id="review-grid" class="review-grid">
        <!-- Cards go here -->
      </div>
      <button
        class="primary"
        id="review-continue-btn"
        onclick="continueFromReview()"
      >
        Continue
      </button>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paper.js/0.12.17/paper-full.min.js"></script>
    <script src="paper-offset.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="text/javascript">
      jQuery.fn.live = function (types, data, fn) {
        jQuery(this.context).on(types, this.selector, data, fn);
        return this;
      };
    </script>
    <script src="hanzi-writer.js"></script>
    <script src="calligraphy.js" type="text/javascript"></script>
    <script src="brushes.js" type="text/javascript"></script>
    <script src="kanjivg-loader.js" type="text/javascript"></script>

    <!-- Externalized Utilities -->
    <script src="app-utils.js"></script>

    <script>
      // --- Constants ---
      const CANVAS_WIDTH = 350;
      const CANVAS_HEIGHT = 350;

      // --- State ---
      let studyList = [];
      let currentWordIndex = 0;
      let sessionResults = {}; // Map wordIndex -> { perfect: bool, mistakes: int }
      let stats = { perfect: 0, imperfect: 0 };

      let currentKanjiArray = [];
      let currentKanjiIndex = 0;
      let writer = null;

      // Settings
      let repetitionGoal = 1;
      let isStrictMode = false;
      let writeKanaEnabled = false;
      let currentRepetition = 0;
      let currentCharMistakes = 0;
      let currentWordHasMistake = false;

      // --- Initialization ---
      window.onload = function () {
        document.getElementById("csv-input").value = EXAMPLE_CSV;
      };

      // --- Study Flow ---
      function startStudy() {
        const input = document.getElementById("csv-input").value;
        studyList = parseCSV(input);
        if (studyList.length === 0) {
          alert("No valid words.");
          return;
        }
        studyList = studyList.sort(() => Math.random() - 0.5);

        repetitionGoal = parseInt(document.getElementById("mode-select").value);
        isStrictMode = document.getElementById("strict-mode").checked;
        writeKanaEnabled = document.getElementById("write-kana").checked;

        stats = { perfect: 0, imperfect: 0 };
        sessionResults = {};
        updateStatsUI(stats, currentWordIndex, studyList.length);

        currentWordIndex = 0;

        document.getElementById("setup-section").style.display = "none";
        document.getElementById("study-section").style.display = "flex";
        document.getElementById("review-section").style.display = "none";

        initCalligraphy(CANVAS_WIDTH, CANVAS_HEIGHT);
        toggleGuides();
        loadWord();
      }

      function prevWord() {
        if (currentWordIndex > 0) {
          currentWordIndex--;
          if (sessionResults[currentWordIndex]) {
            if (sessionResults[currentWordIndex].perfect) stats.perfect--;
            else stats.imperfect--;
            delete sessionResults[currentWordIndex];
          }
          updateStatsUI(stats, currentWordIndex, studyList.length);
          loadWord();
        }
      }

      function skipWord() {
        if (currentWordIndex < studyList.length) {
          stats.imperfect++;
          sessionResults[currentWordIndex] = {
            perfect: false,
            word: studyList[currentWordIndex],
          };
          currentWordIndex++;
          updateStatsUI(stats, currentWordIndex, studyList.length);
          loadWord();
        }
      }

      function loadWord() {
        // Toggle Back Button
        const backBtn = document.getElementById("back-btn");
        backBtn.style.display =
          currentWordIndex === 0 ? "none" : "inline-block";

        // Check Review Interval
        if (
          currentWordIndex > 0 &&
          currentWordIndex % 10 === 0 &&
          !sessionResults["reviewed_" + currentWordIndex]
        ) {
          showReviewScreen(false, currentWordIndex, studyList, sessionResults);
          sessionResults["reviewed_" + currentWordIndex] = true;
          return;
        }

        if (currentWordIndex >= studyList.length) {
          showReviewScreen(true, currentWordIndex, studyList, sessionResults);
          return;
        }

        const data = studyList[currentWordIndex];
        currentWordHasMistake = false;

        let kanaHtml = "";
        if (data.readingRaw.includes("|")) {
          const parts = data.readingRaw.split("|");
          kanaHtml = "";
          for (let p of parts) {
            kanaHtml += `<span>${p}</span>`;
          }
        } else {
          kanaHtml = data.readingRaw;
        }

        document.getElementById("question-kana").innerHTML = kanaHtml;
        document.getElementById("question-def").textContent = data.def;
        document.getElementById("status-text").textContent = "";

        currentKanjiArray = data.kanji.split("");
        currentKanjiIndex = 0;

        updateWordProgress(currentKanjiArray, currentKanjiIndex);
        loadCurrentKanji();
        updateStatsUI(stats, currentWordIndex, studyList.length);
      }

      function loadCurrentKanji() {
        if (currentKanjiIndex >= currentKanjiArray.length) {
          // Word Done
          if (currentWordHasMistake) stats.imperfect++;
          else stats.perfect++;

          sessionResults[currentWordIndex] = {
            perfect: !currentWordHasMistake,
            word: studyList[currentWordIndex],
          };

          document.getElementById("status-text").textContent = "Word Complete!";

          // Add pause before next word
          setTimeout(() => {
            currentWordIndex++;
            loadWord();
          }, 2000);
          return;
        }

        const char = currentKanjiArray[currentKanjiIndex];

        // Skip Kana if setting is unchecked
        if (!writeKanaEnabled && isKana(char)) {
          currentKanjiIndex++;
          updateWordProgress(currentKanjiArray, currentKanjiIndex);
          loadCurrentKanji();
          return;
        }

        currentRepetition = 0;
        setupWriter(char);
      }

      function continueFromReview() {
        document.getElementById("review-section").style.display = "none";
        document.getElementById("study-section").style.display = "flex";
        loadWord();
      }

      // --- Quiz Logic & Writer Setup ---

      const kanjiVGCharDataLoader = (char, onComplete, onError) => {
        const codePoint = char.codePointAt(0);
        let filename = codePoint.toString(16).toLowerCase().padStart(5, "0");
        if (isKana(char)) {
          // hiragana is broken from kanjivg
          fetch(
            `https://cdn.jsdelivr.net/npm/kanji-writer-data-jp@latest/${char}.json`,
          )
            .then((r) => r.json())
            .then(onComplete);
          return;
        }
        fetch(`kanji/${filename}.svg`)
          .then(async (res) => {
            if (!res.ok) throw new Error("Not found");
            let svg = await res.text();
            let json = processKanjiSVG(svg);
            return bufferObjectStrokes(json);
          })
          .then(onComplete)
          .catch(onError);
      };

      function setupWriter(char) {
        clearCanvas();
        document.getElementById("character-target").innerHTML = "";
        document.getElementById("status-text").textContent = "Loading...";

        let showOutline = false;
        if (repetitionGoal > 1 && currentRepetition < 4) {
          showOutline = true;
        }

        document.getElementById("repetition-text").innerText =
          repetitionGoal > 1
            ? `Repetition: ${currentRepetition + 1} / ${repetitionGoal}`
            : "";

        writer = HanziWriter.create("character-target", char, {
          charDataLoader: kanjiVGCharDataLoader,
          width: CANVAS_WIDTH,
          height: CANVAS_HEIGHT,
          padding: 20,
          showOutline: showOutline,
          showCharacter: true,
          strokeAnimationSpeed: 1,
          strokeFadeDuration: 1,
          strokeHighlightSpeed: 1,
          highlightOnComplete: false,
          delayBetweenStrokes: 0,
          strokeColor: "#fff",
          highlightColor: "#dee0e4",
          outlineColor: "#dee0e4",
          drawingColor: "#fff",
          drawingFadeDuration: 0,
          showHintAfterMisses: 3,
          averageDistanceThreshold: 400,
          onLoadCharDataError: () => {
            console.log("Failed to load data for " + char);
            currentKanjiIndex++;
            updateWordProgress(currentKanjiArray, currentKanjiIndex);
            loadCurrentKanji();
          },
          onLoadCharDataSuccess: () => {
            runQuiz();
          },
        });
      }

      function runQuiz() {
        const statusEl = document.getElementById("status-text");
        statusEl.textContent = "";
        currentCharMistakes = 0;
        let strictResetTriggered = false;

        writer.quiz({
          delineateStrokes: true,
          onMistake: function (strokeData) {
            statusEl.textContent = "Mistake!";
            statusEl.style.color = "orange";
            undoStroke();
            currentCharMistakes++;
            currentWordHasMistake = true;

            if (isStrictMode && !strictResetTriggered) {
              strictResetTriggered = true;
              statusEl.textContent = "Strict Mode: Resetting character...";
              writer.cancelQuiz();

              setTimeout(() => {
                setupWriter(currentKanjiArray[currentKanjiIndex]);
              }, 1000);
            }
          },
          onCorrectStroke: function (d) {
            console.log("correct", d);
            if (strictResetTriggered) return;
            statusEl.textContent = "Good";
            statusEl.style.color = "#007bff";
            // writer.highlightStroke(d.strokeNum);
          },
          onComplete: function (d) {
            if (strictResetTriggered) return;

            statusEl.textContent = "Correct!";
            statusEl.style.color = "green";
            writer.updateColor("strokeColor", "#8ac926");

            setTimeout(() => {
              currentRepetition++;
              if (currentRepetition < repetitionGoal) {
                setupWriter(currentKanjiArray[currentKanjiIndex]);
              } else {
                currentKanjiIndex++;
                updateWordProgress(currentKanjiArray, currentKanjiIndex);
                loadCurrentKanji();
              }
            }, 500);
          },
        });
      }
    </script>
  </body>
</html>
