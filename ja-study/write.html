<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calligraphy Kanji Study</title>
    <script type="text/javascript" src="app-utils.js"></script>

    <link rel="stylesheet" type="text/css" href="style.css" />
    <style>
      /* Additional styles for the new context list */
      .context-list {
        max-height: 100px;
        overflow-y: auto;
        margin-bottom: 10px;
        text-align: left;
        width: 100%;
        font-size: 1.2rem;
        border-top: 1px solid #eee;
        border-bottom: 1px solid #eee;
        padding: 10px;
      }
      .context-item {
        display: inline-block;
        margin-right: 15px;
        color: #555;
      }
      .context-highlight {
        color: #41b1e6;
        font-weight: bold;
        text-decoration: underline;
      }
      #stat-progress {
        font-size: 1.2rem;
        font-weight: bold;
        color: #555;
      }
    </style>
  </head>
  <body>
    <!-- SECTION 1: SETUP -->
    <div id="setup-section">
      <div class="setup-row">
        <label
          >Load Preset:
          <select id="preset-list" onchange="loadPreset()">
            <option value="kanken10">Kanken 10</option>
            <option value="kanken9">Kanken 9</option>
            <option value="custom">Custom (Paste below)</option>
          </select>
        </label>
      </div>
      <div class="setup-row">
        <label
          >Mode:
          <select id="mode-select">
            <option value="1">Review (1x)</option>
            <option value="10">Learning (10x)</option>
          </select>
        </label>
        <label> <input type="checkbox" id="shuffle" /> Shuffle </label>
        <label> <input type="checkbox" id="write-kana" /> Write Kana </label>
      </div>
      <p>Data (CSV: tags, kanji, readings, definition):</p>
      <textarea id="csv-input"></textarea>
      <button class="primary" onclick="startStudy()">Start Studying</button>
    </div>

    <!-- SECTION 2: STUDY INTERFACE -->
    <div id="study-section">
      <div id="stats-bar">
        <!-- Stats removed, just progress -->
        <div class="stat-item">
          <span id="stat-progress">0/0</span>
        </div>
      </div>

      <div class="info-card">
        <!-- This container changes based on mode -->
        <div id="learning-context-container" style="display: none">
          <div class="context-list" id="context-word-list"></div>
        </div>

        <div id="review-context-container">
          <div class="kana-display" id="question-kana"></div>
          <div class="word-display" id="word-progress-display"></div>
          <div class="def-display" id="question-def"></div>
        </div>
      </div>

      <div id="canvas-container">
        <div id="character-target"></div>
        <div id="hand-image"></div>
        <canvas
          id="layered-canvas"
          class="calligraphy-layer"
          width="350"
          height="350"
        ></canvas>
        <canvas
          id="write-canvas"
          class="calligraphy-layer"
          width="350"
          height="350"
        ></canvas>
        <canvas
          id="hand-canvas"
          class="calligraphy-layer"
          width="350"
          height="350"
        ></canvas>
      </div>
      <div class="status-container">
        <div id="status-text"></div>
        <div id="repetition-text" style="font-size: 0.8em; color: #999"></div>
      </div>
      <!-- Navigation / Exit Controls -->
      <div class="controls">
        <div class="btn-group">
          <button id="back-btn" class="danger" onclick="prevItem()">
            Back
          </button>
          <button class="secondary" onclick="restartItem()">Restart</button>
          <button class="nextButton" onclick="forceNext()">Next &rarr;</button>
        </div>
      </div>

      <!-- Live Controls -->
      <div class="controls">
        <div style="width: 10px"></div>
        <button class="secondary" id="outline-btn" onclick="toggleOutline()">
          Outline
        </button>
        <button class="secondary" id="brush-btn" onclick="toggleBrush()">
          Brush
        </button>
        <button class="secondary" id="drawing-btn" onclick="toggleDrawing()">
          Drawing
        </button>
        <button class="secondary" onclick="undoStroke()">Undo</button>
        <button class="secondary" onclick="toggleFont()">Font</button>
        <button class="secondary" onclick="toggleCorrectStrokes()">
          Strokes
        </button>
        <button onclick="setBrush('Small')">Small</button>
        <button onclick="setBrush('SmallMed')">SmallMed</button>
        <button onclick="setBrush('Medium')">Medium</button>
        <button onclick="setBrush('Large')">Large</button>
        <label>
          <input
            type="checkbox"
            id="guide-toggle"
            onchange="toggleGuides()"
            checked
          />
          Guides
        </label>
      </div>
    </div>

    <!-- SECTION 3: REVIEW / FINISH -->
    <div id="review-section">
      <h2 id="review-title">Session Complete</h2>
      <div id="review-grid" class="review-grid">
        <!-- Cards go here -->
      </div>
      <button
        class="primary"
        id="review-continue-btn"
        onclick="continueFromReview()"
      >
        Continue
      </button>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paper.js/0.12.17/paper-full.min.js"></script>
    <script src="paper-offset.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="text/javascript">
      jQuery.fn.live = function (types, data, fn) {
        jQuery(this.context).on(types, this.selector, data, fn);
        return this;
      };
    </script>
    <script type="text/javascript" src="levels.js"></script>
    <script type="text/javascript" src="hanzi-writer.js"></script>
    <script type="text/javascript" src="calligraphy.js"></script>
    <script type="text/javascript" src="brushes.js"></script>
    <script type="text/javascript" src="kanjivg-loader.js"></script>

    <script type="text/javascript">
      // --- Constants ---
      const CANVAS_WIDTH = 350;
      const CANVAS_HEIGHT = 350;
      var LOADER = kanjiVGCharDataLoader;
      var usingKanjiVG = true;

      // --- State ---
      let studyList = []; // The list of words (CSV data)
      let activeKanjiQueue = []; // For Learning Mode: List of chars

      let currentIndex = 0; // Index in studyList (Review) or activeKanjiQueue (Learning)

      let currentKanjiArray = [];
      let currentKanjiSubIndex = 0;

      let writer = null;
      window.writer = writer;

      // Settings
      let mode = 1; // 1 or 10
      let isShuffling = false;
      let writeKanaEnabled = false;
      let activeKanjiSetString = null;

      // Visual States
      let isOutlineVisible = false;
      let isDrawingEnabled = false;
      let isBrushVisible = false;
      let isCorrectStrokesEnabled = false;

      let layeredCanvas = document.querySelector("#layered-canvas");
      var nextButton = document.querySelector(".nextButton");

      // Colors
      var clear = "rgba(0, 0, 0, 0)";
      var blue = "rgba(65, 177, 230, 1)";
      var gray = "#dee0e4";
      var highlightColor = blue;
      var strokeColor = clear;
      var outlineColor = gray;
      var drawingColor = clear;

      // Progress Trackers
      let currentRepetition = 0; // 0 to 9 for Learning Mode

      window.onload = function () {
        loadPreset();
      };

      function startStudy() {
        const input = document.getElementById("csv-input").value;
        studyList = parseCSV(input); // Provided in app-utils
        if (studyList.length === 0) {
          alert("No valid words.");
          return;
        }

        mode = parseInt(document.getElementById("mode-select").value);
        isShuffling = document.getElementById("shuffle").checked;
        writeKanaEnabled = document.getElementById("write-kana").checked;

        // Determine active kanji list
        const presetVal = document.getElementById("preset-list").value;
        if (presetVal === "kanken10" && typeof kanken10kanji !== "undefined") {
          activeKanjiSetString = kanken10kanji;
        } else if (
          presetVal === "kanken9" &&
          typeof kanken9kanji !== "undefined"
        ) {
          activeKanjiSetString = kanken9kanji;
        } else {
          let allK = studyList.map((item) => item.kanji).join("");
          let unique = [...new Set(allK.split(""))]
            .filter((c) => !isKana(c))
            .join("");
          activeKanjiSetString = unique;
        }

        currentIndex = 0;

        if (mode === 10) {
          // LEARNING MODE: Setup Queue based on Kanji Set
          activeKanjiQueue = activeKanjiSetString.split("");
          if (isShuffling) activeKanjiQueue.sort(() => Math.random() - 0.5);
          document.getElementById("learning-context-container").style.display =
            "block";
          document.getElementById("review-context-container").style.display =
            "none";
        } else {
          // REVIEW MODE: Setup Queue based on Words
          if (isShuffling)
            studyList = studyList.sort(() => Math.random() - 0.5);
          document.getElementById("learning-context-container").style.display =
            "none";
          document.getElementById("review-context-container").style.display =
            "block";
        }

        document.getElementById("setup-section").style.display = "none";
        document.getElementById("study-section").style.display = "flex";
        document.getElementById("review-section").style.display = "none";

        initCalligraphy(CANVAS_WIDTH, CANVAS_HEIGHT);
        toggleGuides();

        loadItem();
      }

      function loadItem() {
        nextButton.classList.remove("primary");
        document.getElementById("character-target").innerHTML = "";
        clearCanvas();
        updateStatus("");

        if (mode === 10) {
          loadLearningModeItem();
        } else {
          loadReviewModeItem();
        }
      }

      // Helper to detect Kanji (common CJK range)
      function isKanjiChar(ch) {
        return (ch >= "\u4e00" && ch <= "\u9faf") || ch === "々";
      }

      // ==========================================
      // LEARNING MODE LOGIC (10x Reps)
      // ==========================================
      function loadLearningModeItem() {
        if (currentIndex >= activeKanjiQueue.length) {
          showFinishScreen();
          return;
        }

        const targetChar = activeKanjiQueue[currentIndex];
        document.getElementById("stat-progress").innerText =
          `${currentIndex + 1}/${activeKanjiQueue.length} (Kanji)`;

        const contextDiv = document.getElementById("context-word-list");
        contextDiv.innerHTML = "";

        const relevantWords = studyList.filter((w) =>
          w.kanji.includes(targetChar),
        );

        if (relevantWords.length === 0) {
          contextDiv.innerHTML =
            "<em>No example words in current dataset.</em>";
        } else {
          relevantWords.forEach((word) => {
            const span = document.createElement("span");
            span.className = "context-item";

            const kString = word.kanji;
            // Handle cases where reading isn't split by pipes gracefully
            const rParts = word.readingRaw.includes("|")
              ? word.readingRaw.split("|")
              : [word.readingRaw];

            let html = "";
            let kCursor = 0; // Cursor for the kanji string

            // Iterate through Reading Parts and map to Kanji String
            for (let i = 0; i < rParts.length; i++) {
              const rPart = rParts[i];

              // Safety: if we ran out of string characters
              if (kCursor >= kString.length) {
                html += rPart;
                continue;
              }

              const charAtCursor = kString[kCursor];

              if (isKanjiChar(charAtCursor)) {
                // Case 1: Cursor is at a Kanji
                // We assume this entire reading part belongs to this Kanji
                if (charAtCursor === targetChar) {
                  html += `<span class="context-highlight">${rPart}</span>`;
                } else {
                  html += rPart;
                }
                kCursor++; // Move cursor past this Kanji
              } else {
                // Case 2: Cursor is at Kana/Symbol
                // We assume the text in the string matches the reading part
                // (e.g. "ごはん" matches "ごはん", "を" matches "を")
                html += rPart;

                // Advance cursor by length of reading part
                // (e.g. "ごはん" is 3 chars, so skip 3 chars in string)
                // Note: This assumes strict mapping.
                // Fallback: if lengths don't align logically (e.g. "は" vs "わ"),
                // we usually just advance by reading length or 1.
                // Given Kanken data usually has matching kana literals:
                kCursor += rPart.length;
              }
            }

            span.innerHTML = html;
            contextDiv.appendChild(span);
          });
        }

        currentRepetition = 0;
        setupWriter(targetChar);
      }

      // ==========================================
      // REVIEW MODE LOGIC (1x Rep)
      // ==========================================
      function loadReviewModeItem() {
        if (currentIndex >= studyList.length) {
          showFinishScreen();
          return;
        }

        const data = studyList[currentIndex];
        document.getElementById("stat-progress").innerText =
          `${currentIndex + 1}/${studyList.length} (Words)`;

        let kanaHtml = data.readingRaw.replace(/\|/g, "<span></span>");
        if (data.readingRaw.includes("|")) {
          kanaHtml = data.readingRaw
            .split("|")
            .map((s) => `<span>${s}</span>`)
            .join("");
        }

        document.getElementById("question-kana").innerHTML = kanaHtml;
        document.getElementById("question-def").textContent = data.def;
        document
          .querySelector(".def-display")
          .classList.remove("def-display-show");

        const backBtn = document.getElementById("back-btn");
        backBtn.style.display = currentIndex === 0 ? "none" : "inline-block";

        currentKanjiArray = data.kanji.split("");
        currentKanjiSubIndex = 0;

        updateWordProgress(
          currentKanjiArray,
          currentKanjiSubIndex,
          activeKanjiSetString,
        );
        loadNextReviewChar();
      }

      function loadNextReviewChar() {
        if (currentKanjiSubIndex >= currentKanjiArray.length) {
          updateStatus("Word Complete!");
          document
            .querySelector(".def-display")
            .classList.add("def-display-show");
          nextButton.classList.add("primary");
          return;
        }

        const char = currentKanjiArray[currentKanjiSubIndex];

        let shouldQuiz = true;
        if (isKana(char) && !writeKanaEnabled) shouldQuiz = false;
        if (
          !isKana(char) &&
          activeKanjiSetString &&
          !activeKanjiSetString.includes(char)
        )
          shouldQuiz = false;

        if (!shouldQuiz) {
          currentKanjiSubIndex++;
          updateWordProgress(
            currentKanjiArray,
            currentKanjiSubIndex,
            activeKanjiSetString,
          );
          loadNextReviewChar();
          return;
        }

        currentRepetition = 0;
        setupWriter(char);
      }

      // ==========================================
      // CONTROLS & WRITER
      // ==========================================

      function prevItem() {
        if (currentIndex > 0) {
          currentIndex--;
          loadItem();
        }
      }

      function restartItem() {
        loadItem();
      }

      function forceNext() {
        currentIndex++;
        loadItem();
      }

      function showFinishScreen() {
        document.getElementById("study-section").style.display = "none";
        document.getElementById("review-section").style.display = "flex";
      }

      function continueFromReview() {
        location.reload();
      }

      function setupWriter(char) {
        document.getElementById("character-target").innerHTML = "";
        clearCanvas();
        updateStatus("Loading...");
        configureEnvironmentForRep(currentRepetition);

        let repText = "";
        if (mode === 10) repText = `Repetition: ${currentRepetition + 1} / 10`;
        document.getElementById("repetition-text").innerText = repText;

        writer = HanziWriter.create("character-target", char, {
          charDataLoader: LOADER,
          width: CANVAS_WIDTH,
          height: CANVAS_HEIGHT,
          padding: 20,
          showOutline: isOutlineVisible,
          showCharacter: false,
          strokeAnimationSpeed: 250,
          delayBetweenStrokes: 0,
          strokeColor: strokeColor,
          highlightColor: highlightColor,
          outlineColor: outlineColor,
          drawingColor: drawingColor,
          drawingFadeDuration: 0,
          showHintAfterMisses: 2,
          onLoadCharDataError: () => {
            updateStatus("Error loading " + char);
            onCompleteHandler();
          },
          onLoadCharDataSuccess: () => {
            runQuiz();
          },
        });
      }

      function configureEnvironmentForRep(repIndex) {
        if (mode === 1) {
          isOutlineVisible = false;
          enableDrawing();
          disableBrush();
          showCorrectStrokes();
          return;
        }
        // Learning Mode (10 reps)
        if (repIndex >= 0 && repIndex <= 2) {
          // 1-3
          isOutlineVisible = true;
          enableDrawing();
          disableBrush();
          showCorrectStrokes();
        } else if (repIndex >= 3 && repIndex <= 5) {
          // 4-6
          isOutlineVisible = false;
          enableDrawing();
          disableBrush();
          showCorrectStrokes();
        } else {
          // 7-10
          isOutlineVisible = false;
          disableDrawing();
          enableBrush();
          hideCorrectStrokes();
        }
      }

      function runQuiz() {
        updateStatus("");
        writer.quiz({
          delineateStrokes: true,
          onMistake: function (strokeData) {
            updateStatus("Mistake!", "orange");
            undoStroke();
          },
          onCorrectStroke: function (d) {
            updateStatus("Good", "#007bff");
            if (isCorrectStrokesEnabled)
              writer.highlightStroke(d.strokeNum, { fadeHighlightOut: false });
          },
          onComplete: function (d) {
            updateStatus("Correct!", blue);
            setTimeout(() => {
              onCompleteHandler();
            }, 500);
          },
        });
      }

      function onCompleteHandler() {
        if (mode === 10) {
          currentRepetition++;
          if (currentRepetition < 10) {
            setupWriter(activeKanjiQueue[currentIndex]);
          } else {
            currentIndex++;
            loadItem();
          }
        } else {
          currentKanjiSubIndex++;
          updateWordProgress(
            currentKanjiArray,
            currentKanjiSubIndex,
            activeKanjiSetString,
          );
          loadNextReviewChar();
        }
      }

      function toggleFont() {
        if (usingKanjiVG) {
          usingKanjiVG = false;
          LOADER = animCJKLoader;
        } else {
          usingKanjiVG = true;
          LOADER = kanjiVGCharDataLoader;
        }
        setupWriter(
          mode === 10
            ? activeKanjiQueue[currentIndex]
            : currentKanjiArray[currentKanjiSubIndex],
        );
      }

      function toggleBrush() {
        if (isBrushVisible) disableBrush();
        else enableBrush();
      }

      function enableBrush() {
        isBrushVisible = true;
        layeredCanvas.style.opacity = "1";
        setBrushOpacity(1);
      }

      function disableBrush() {
        isBrushVisible = false;
        layeredCanvas.style.opacity = "0";
        setBrushOpacity(0);
      }

      function toggleDrawing() {
        if (isDrawingEnabled) disableDrawing();
        else enableDrawing();
      }

      function enableDrawing() {
        isDrawingEnabled = true;
        drawingColor = blue;
        if (writer) writer.updateColor("drawingColor", blue);
      }

      function disableDrawing() {
        isDrawingEnabled = false;
        drawingColor = clear;
        if (writer) writer.updateColor("drawingColor", clear);
      }

      function toggleCorrectStrokes() {
        if (isCorrectStrokesEnabled) hideCorrectStrokes();
        else showCorrectStrokes();
      }

      function showCorrectStrokes() {
        isCorrectStrokesEnabled = true;
        // highlightColor = "rgba(65, 177, 230, 1)";
        // if (writer) writer.updateColor("highlightColor", highlightColor);
      }

      function hideCorrectStrokes() {
        isCorrectStrokesEnabled = false;
        // highlightColor = clear;
        // if (writer) writer.updateColor("highlightColor", highlightColor);
      }

      function toggleOutline() {
        isOutlineVisible = !isOutlineVisible;
        if (writer) {
          if (isOutlineVisible) writer.showOutline();
          else writer.hideOutline();
        }
      }
    </script>
  </body>
</html>
