<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Travel Time Map with Filter</title>

    <!-- MapLibre GL JS -->
    <link
      href="https://unpkg.com/maplibre-gl@4.0.0/dist/maplibre-gl.css"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/maplibre-gl@4.0.0/dist/maplibre-gl.js"></script>

    <!-- noUiSlider (For the range slider) -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>

    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: "Helvetica Neue", Arial, Helvetica, sans-serif;
      }
      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }

      /* Legend Styles */
      .legend {
        background-color: #fff;
        border-radius: 3px;
        bottom: 30px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        padding: 10px;
        position: absolute;
        right: 10px;
        z-index: 1;
      }
      .legend h4 {
        margin: 0 0 10px;
      }
      .legend-key {
        display: inline-block;
        width: 10px;
        height: 10px;
        margin-right: 5px;
        border-radius: 50%;
      }

      /* Slider Overlay Styles */
      .map-overlay {
        font: 12px/20px "Helvetica Neue", Arial, Helvetica, sans-serif;
        position: absolute;
        width: 250px;
        top: 20px;
        left: 20px;
        padding: 15px;
        background-color: #fff;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        border-radius: 3px;
        z-index: 2;
      }

      .map-overlay h2 {
        margin: 0 0 10px;
        font-size: 14px;
        line-height: 18px;
        font-weight: bold;
      }

      .map-overlay .range-values {
        margin-top: 10px;
        display: flex;
        justify-content: space-between;
        font-weight: bold;
        color: #333;
      }

      /* Override noUiSlider styles for a cleaner look */
      .noUi-connect {
        background: #007cbf;
      }
      .noUi-horizontal {
        height: 10px;
      }
      .noUi-handle {
        height: 18px;
        width: 18px;
        top: -5px;
        right: -9px; /* half width */
        border-radius: 50%;
        cursor: pointer;
      }
      .noUi-handle:before,
      .noUi-handle:after {
        display: none; /* Hide the default tick marks on handle */
      }
    </style>
  </head>
  <body>
    <!-- Slider Overlay -->
    <div class="map-overlay">
      <h2>Filter by Travel Time</h2>
      <div id="time-slider"></div>
      <div class="range-values">
        <span id="min-val"></span>
        <span id="max-val"></span>
      </div>
    </div>

    <div id="map"></div>

    <div class="legend">
      <h4>Travel Time</h4>
      <div>
        <span class="legend-key" style="background: #00ff00"></span>Short (Fast
        / Large)
      </div>
      <div>
        <span class="legend-key" style="background: #ff0000"></span>Long (Slow /
        Small)
      </div>
    </div>

    <script>
      async function run() {
        async function fetchJsonData(url) {
          try {
            const response = await fetch(url);
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            return data;
          } catch (error) {
            console.error("Could not fetch JSON data:", error);
            throw error;
          }
        }

        function parseDuration(timeStr) {
          if (!timeStr) return 0;
          let totalMinutes = 0;
          const hoursMatch = timeStr.match(/(\d+)時間/);
          if (hoursMatch) {
            totalMinutes += parseInt(hoursMatch[1], 10) * 60;
          }
          const minutesMatch = timeStr.match(/(\d+)分/);
          if (minutesMatch) {
            totalMinutes += parseInt(minutesMatch[1], 10);
          }
          if (totalMinutes === 0 && !isNaN(parseInt(timeStr))) {
            totalMinutes = parseInt(timeStr);
          }
          return totalMinutes;
        }

        // 1. Fetch Data
        const rawData = await fetchJsonData("./results.json");

        // 2. Process Data
        const features = rawData.map((item) => {
          const timeValue = parseDuration(item.route_details.totalTime);
          return {
            type: "Feature",
            geometry: {
              type: "Point",
              coordinates: [item.lon, item.lat],
            },
            properties: {
              station: item.station_name_kanji,
              timeString: item.route_details.totalTime,
              timeValue: timeValue,
              description: item.route_details.path,
            },
          };
        });

        const destinationGeoJSON = {
          type: "FeatureCollection",
          features: features,
        };

        // 3. Calculate Ranges
        const times = features.map((f) => f.properties.timeValue);
        const minTime = Math.min(...times);
        const maxTime = Math.max(...times);

        const safeMaxTime = minTime === maxTime ? maxTime + 10 : maxTime;

        // 4. Initialize Slider
        const slider = document.getElementById("time-slider");
        const minValDisplay = document.getElementById("min-val");
        const maxValDisplay = document.getElementById("max-val");

        noUiSlider.create(slider, {
          start: [minTime, safeMaxTime],
          connect: true,
          step: 1,
          range: {
            min: minTime,
            max: safeMaxTime,
          },
          tooltips: false,
        });

        // 5. Origin Point
        const originGeoJSON = {
          type: "FeatureCollection",
          features: [
            {
              type: "Feature",
              geometry: { type: "Point", coordinates: [139.582582, 35.697435] },
              properties: { name: "Origin" },
            },
          ],
        };

        // 6. Initialize Map
        const map = new maplibregl.Map({
          container: "map",
          style:
            "https://api.maptiler.com/maps/bright/style.json?key=VK9en7fqcN8VTzfv5LVe",
          center: [139.68, 35.65],
          zoom: 10,
        });

        map.on("load", () => {
          // --- LAYER: Destinations ---
          map.addSource("destinations", {
            type: "geojson",
            data: destinationGeoJSON,
          });

          // Initial Render - Uses initial minTime/safeMaxTime
          map.addLayer({
            id: "destinations-circles",
            type: "circle",
            source: "destinations",
            paint: {
              "circle-radius": [
                "interpolate",
                ["linear"],
                ["get", "timeValue"],
                minTime,
                30,
                safeMaxTime,
                10,
              ],
              "circle-color": [
                "interpolate",
                ["linear"],
                ["get", "timeValue"],
                minTime,
                "#00FF00",
                safeMaxTime,
                "#FF0000",
              ],
              "circle-opacity": 0.8,
              "circle-stroke-color": "#ffffff",
              "circle-stroke-width": 2,
            },
          });

          map.addLayer({
            id: "destinations-labels",
            type: "symbol",
            source: "destinations",
            layout: {
              "text-field": ["get", "station"],
              "text-offset": [0, 2.5],
              "text-size": 12,
            },
            paint: {
              "text-color": "#000",
              "text-halo-color": "#fff",
              "text-halo-width": 2,
            },
          });

          // --- LAYER: Origin ---
          map.addSource("origin", { type: "geojson", data: originGeoJSON });

          map.addLayer({
            id: "origin-circle",
            type: "circle",
            source: "origin",
            paint: {
              "circle-radius": 15,
              "circle-color": "#FFFFFF",
              "circle-stroke-color": "#000000",
              "circle-stroke-width": 3,
            },
          });

          // --- SLIDER EVENT LISTENER ---
          slider.noUiSlider.on("update", function (values) {
            const currentMin = parseInt(values[0]);
            const currentMax = parseInt(values[1]);

            // Ensure we don't have a 0 range for interpolation
            const safeCurrentMax =
              currentMax === currentMin ? currentMax + 0.1 : currentMax;

            // 1. Update Text Display
            minValDisplay.innerHTML = `${currentMin} min`;
            maxValDisplay.innerHTML = `${currentMax} min`;

            // 2. Filter the Layers
            const filter = [
              "all",
              [">=", ["get", "timeValue"], currentMin],
              ["<=", ["get", "timeValue"], currentMax],
            ];
            map.setFilter("destinations-circles", filter);
            map.setFilter("destinations-labels", filter);

            // 3. Dynamically re-scale Color
            // Current Min -> Green (#00FF00)
            // Current Max -> Red (#FF0000)
            map.setPaintProperty("destinations-circles", "circle-color", [
              "interpolate",
              ["linear"],
              ["get", "timeValue"],
              currentMin,
              "#00FF00",
              safeCurrentMax,
              "#FF0000",
            ]);

            // 4. Dynamically re-scale Radius to match legend logic (Short/Fast = Large)
            // Current Min -> 30px
            // Current Max -> 10px
            map.setPaintProperty("destinations-circles", "circle-radius", [
              "interpolate",
              ["linear"],
              ["get", "timeValue"],
              currentMin,
              30,
              safeCurrentMax,
              10,
            ]);
          });

          // Popups
          map.on("click", "destinations-circles", (e) => {
            const props = e.features[0].properties;
            new maplibregl.Popup()
              .setLngLat(e.lngLat)
              .setHTML(
                `<strong>${props.station}</strong><br>
                 ${props.timeValue} mins`
              )
              .addTo(map);
          });

          map.on(
            "mouseenter",
            "destinations-circles",
            () => (map.getCanvas().style.cursor = "pointer")
          );
          map.on(
            "mouseleave",
            "destinations-circles",
            () => (map.getCanvas().style.cursor = "")
          );
        });
      }

      run();
    </script>
  </body>
</html>
